<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK - Final Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; }
        #cameraOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #videoStream { width: 100%; height: 100%; object-fit: cover; }
        
        /* PLAKA ODAK ÇERÇEVESİ - Daha Dar */
        .focus-box {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 80px; border: 4px solid #ef4444; border-radius: 8px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.8); z-index: 1010;
        }
        .scan-anim { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, #ef4444); height: 2px; animation: scan 1.5s infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="pb-10">

<div id="cameraOverlay">
    <video id="videoStream" autoplay playsinline></video>
    <div class="focus-box"><div class="scan-anim"></div></div>
    <div class="absolute bottom-10 inset-x-0 flex flex-col items-center gap-4 z-[1100]">
        <div id="status" class="bg-red-600 text-white text-[10px] px-4 py-1 rounded font-bold uppercase">SADECE PLAKAYI KUTUYA ALIN</div>
        <div class="flex items-center gap-10">
            <button onclick="closeCam()" class="text-white opacity-50 font-bold">İPTAL</button>
            <button onclick="captureAndRead()" class="w-20 h-20 bg-white rounded-full border-8 border-red-600 shadow-2xl flex items-center justify-center">
                <i class="fas fa-camera text-2xl"></i>
            </button>
            <div class="w-10"></div>
        </div>
    </div>
    <canvas id="hiddenCanvas" style="display:none;"></canvas>
</div>

<div class="max-w-md mx-auto p-4">
    <div class="bg-white rounded-3xl p-6 shadow-xl mb-6 border border-gray-100">
        <div class="relative mb-4">
            <input type="text" id="plakaInp" placeholder="PLAKA" class="w-full py-4 text-3xl font-black text-center border-2 border-gray-100 rounded-2xl focus:border-red-500 outline-none uppercase">
            <button onclick="openCam()" class="absolute right-2 top-2 bottom-2 w-12 bg-red-600 text-white rounded-xl shadow-lg">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <button onclick="saveCar()" class="w-full bg-zinc-900 text-white py-4 rounded-2xl font-black text-xl">KAYDET</button>
    </div>
    <div id="carList" class="space-y-3"></div>
</div>

<script>
let cars = JSON.parse(localStorage.getItem('istay_v3')) || [];
let vStream = null;

async function openCam() {
    try {
        vStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280 } });
        document.getElementById('videoStream').srcObject = vStream;
        document.getElementById('cameraOverlay').style.display = 'block';
    } catch(e) { alert("Kamera Hatası: İzin verilmedi."); }
}

function closeCam() {
    if(vStream) vStream.getTracks().forEach(t => t.stop());
    document.getElementById('cameraOverlay').style.display = 'none';
}

async function captureAndRead() {
    const video = document.getElementById('videoStream');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');

    // Sadece kutu içini kes
    const scale = video.videoWidth / video.clientWidth;
    const w = 80 * (video.clientWidth / 100) * scale;
    const h = 80 * scale;
    const x = (video.videoWidth - w) / 2;
    const y = (video.videoHeight * 0.4) - (h / 2);

    canvas.width = w; canvas.height = h;
    
    // Görüntü İşleme: Çok yüksek kontrast (Siyah-Beyaz)
    ctx.filter = 'grayscale(1) contrast(4) brightness(0.9)';
    ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

    status.innerText = "OKUNUYOR...";

    try {
        const worker = await Tesseract.createWorker('eng');
        await worker.setParameters({ tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' });
        const { data: { text } } = await worker.recognize(canvas);
        await worker.terminate();

        // TEMİZLİK: Gelen uzun metinden sadece plaka formatını bul
        // Örn: 34ABC123 veya 06A1234 gibi yapıları yakalar
        let raw = text.replace(/[^A-Z0-9]/g, "");
        let match = raw.match(/[0-9]{2}[A-Z]{1,3}[0-9]{2,4}/); // TR Plaka Regex
        
        let finalPlaka = match ? match[0] : (raw.length > 4 ? raw.substring(0, 8) : null);

        if(finalPlaka) {
            document.getElementById('plakaInp').value = finalPlaka;
            closeCam();
            render();
        } else {
            status.innerText = "TEKRAR DENEYİN (NETLEŞTİRİN)";
        }
    } catch(e) { status.innerText = "HATA OLUŞTU"; }
}

function saveCar() {
    let p = document.getElementById('plakaInp').value.toUpperCase().trim();
    if(!p) return;
    cars.unshift({ id: Date.now(), plaka: p, giris: new Date().toISOString() });
    localStorage.setItem('istay_v3', JSON.stringify(cars));
    document.getElementById('plakaInp').value = '';
    render();
}

function render() {
    const div = document.getElementById('carList');
    div.innerHTML = '';
    cars.forEach(c => {
        div.innerHTML += `
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border-l-8 border-red-600">
                <div>
                    <div class="text-2xl font-black">${c.plaka}</div>
                    <div class="text-[10px] text-gray-400 font-bold">${new Date(c.giris).toLocaleTimeString()}</div>
                </div>
                <button onclick="delCar(${c.id})" class="text-gray-300"><i class="fas fa-trash"></i></button>
            </div>
        `;
    });
}
function delCar(id) { cars = cars.filter(c => c.id !== id); localStorage.setItem('istay_v3', JSON.stringify(cars)); render(); }
render();
</script>
</body>
</html>
