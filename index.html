<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK - Pro Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.7; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        
        /* PDF Özel Tasarım */
        #pdfReportLayout { display: none; padding: 30px; background: white; color: black; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .pdf-table th { background: #f8f8f8; border: 1px solid #eee; padding: 10px; text-align: left; font-size: 11px; color: #333; }
        .pdf-table td { border: 1px solid #eee; padding: 10px; font-size: 10px; }
        .pdf-footer-box { margin-top: 20px; padding: 15px; border: 2px solid #f0f0f0; border-radius: 8px; }
    </style>
</head>
<body class="pb-20">

    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <button onclick="raporuGoster()" class="rapor-btn-top bg-zinc-700 text-white px-3 py-1.5 rounded-lg text-sm"><i class="fas fa-chart-line"></i> Panel</button>
    </div>

    <div id="pdfReportLayout">
        <div style="border-bottom: 3px solid #e11d48; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">iSTAY PARK | GÜNLÜK HASILAT RAPORU</h1>
            <p id="pdfDateInfo" style="font-size: 11px; color: #666; margin-top: 5px;"></p>
        </div>
        <table class="pdf-table">
            <thead>
                <tr>
                    <th>PLAKA</th>
                    <th>ARAÇ TİPİ</th>
                    <th>GİRİŞ SAATİ</th>
                    <th>ÇIKIŞ SAATİ</th>
                    <th>ÖDEME ŞEKLİ</th>
                    <th>TUTAR</th>
                </tr>
            </thead>
            <tbody id="pdfTableBody"></tbody>
        </table>
        <div id="pdfSummarySection" class="pdf-footer-box"></div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 no-print">
            <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA ARA VEYA GİRİŞ YAP" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl font-bold uppercase text-lg mb-3 text-center">
            <div class="flex gap-2 mb-3">
                <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-3 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white transition">OTOMOBİL</button>
                <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-3 rounded-xl font-bold text-xs border-2 border-gray-200 text-gray-500 transition">MİNİBÜS</button>
            </div>
            <button onclick="aracGiris()" class="w-full bg-zinc-900 text-white py-4 rounded-xl font-black text-lg active:scale-95 transition">SİSTEME GİRİŞ YAP</button>
        </div>
        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <div id="raporModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center no-print">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden max-h-[95vh] flex flex-col">
            <div class="bg-zinc-900 p-5 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg">Yönetim Paneli</h2>
                <div class="flex gap-2">
                    <button onclick="generatePDF()" class="bg-rose-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="raporuKapat()" class="bg-zinc-800 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-1 bg-white">
                <div class="flex border-b">
                    <button onclick="switchTab('rapor')" id="tab_rapor" class="flex-1 py-4 font-bold text-xs border-b-2 border-rose-600 text-rose-600 uppercase">Rapor</button>
                    <button onclick="switchTab('fiyat')" id="tab_fiyat" class="flex-1 py-4 font-bold text-xs text-gray-400 uppercase">Fiyatlar</button>
                    <button onclick="switchTab('veri')" id="tab_veri" class="flex-1 py-4 font-bold text-xs text-gray-400 uppercase">Veri</button>
                </div>

                <div id="pane_rapor" class="p-4">
                    <div id="raporIstatistik" class="grid grid-cols-2 gap-2 mb-4"></div>
                    <div id="raporIcerik" class="max-h-[250px] overflow-auto mb-4"></div>
                    <div id="raporOzetBox" class="bg-gray-50 p-4 rounded-2xl border-2 border-gray-100"></div>
                </div>

                <div id="pane_fiyat" class="hidden p-4">
                    <div id="oto_inputs" class="grid grid-cols-2 gap-2 text-[11px] mb-6"></div>
                    <div id="mini_inputs" class="grid grid-cols-2 gap-2 text-[11px] mb-6"></div>
                    <button onclick="tarifeleriKaydet()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Fiyatları Güncelle</button>
                </div>

                <div id="pane_veri" class="hidden p-5">
                    <button onclick="veriyiDisaAktar()" class="w-full bg-zinc-800 text-white py-3 rounded-xl font-bold text-xs mb-3 uppercase">Yedek Dosyası Al</button>
                    <label class="block w-full bg-zinc-100 text-zinc-600 py-3 rounded-xl font-bold text-xs text-center cursor-pointer mb-8">Dosyadan Veri Yükle <input type="file" id="importFile" class="hidden" onchange="veriyiIceriAktar(event)"></label>
                    <button onclick="raporuSifirla()" class="w-full border-2 border-rose-100 text-rose-500 py-3 rounded-xl font-bold text-[10px] uppercase">Sistemi Tamamen Sıfırla</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-gray-800 mb-4 text-center text-sm uppercase">Zamanı Düzenle</h3>
            <input type="datetime-local" id="editDateTime" class="w-full border-2 border-gray-200 rounded-xl p-3 mb-4 font-bold text-sm">
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-400 text-xs uppercase">İptal</button>
                <button id="saveEditBtn" class="flex-1 py-3 bg-rose-600 rounded-xl font-bold text-white text-xs uppercase shadow-lg">Güncelle</button>
            </div>
        </div>
    </div>

    <script>
        let varsayilanTarife = {
            otomobil: [ { min: 0, max: 1, ucret: 170 }, { min: 1, max: 2, ucret: 210 }, { min: 2, max: 4, ucret: 290 }, { min: 4, max: 6, ucret: 360 }, { min: 6, max: 8, ucret: 420 }, { min: 8, max: 12, ucret: 500 }, { min: 12, max: 24, ucret: 600 } ],
            minibus: [ { min: 0, max: 1, ucret: 250 }, { min: 1, max: 2, ucret: 300 }, { min: 2, max: 4, ucret: 400 }, { min: 4, max: 6, ucret: 500 }, { min: 6, max: 8, ucret: 600 }, { min: 8, max: 12, ucret: 750 }, { min: 12, max: 24, ucret: 900 } ]
        };
        let aktifTarife = JSON.parse(localStorage.getItem('istay_tarifeler')) || varsayilanTarife;
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let seciliAracTipi = 'otomobil';

        function ucretHesapla(girisTarihi, tip) {
            const farkMs = new Date() - new Date(girisTarihi);
            if (farkMs / 60000 <= 4) return 0;
            const toplamSaat = farkMs / 3600000;
            const tamGun = Math.floor(toplamSaat / 24);
            const kalanSaat = toplamSaat % 24;
            const t = aktifTarife[tip] || aktifTarife.otomobil;
            let u = tamGun * t[t.length - 1].ucret;
            if (kalanSaat > 0) {
                let ek = t[0].ucret; 
                for (let k of t) { if (kalanSaat > k.min && kalanSaat <= k.max) { ek = k.ucret; break; } }
                u += ek;
            }
            return u;
        }

        function raporuGoster() {
            const bugun = new Date().toLocaleDateString('tr-TR');
            const bugunCikislar = araclar.filter(a => a.durum === 'tamamlandi' && new Date(a.cikis).toLocaleDateString('tr-TR') === bugun);
            const iceridekiler = araclar.filter(a => a.durum === 'aktif');

            document.getElementById('raporIstatistik').innerHTML = `
                <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100"><div class="text-[9px] font-bold text-blue-400 uppercase">İÇERİDE</div><div class="text-xl font-black text-blue-700">${iceridekiler.length}</div></div>
                <div class="bg-green-50 p-3 rounded-xl text-center border border-green-100"><div class="text-[9px] font-bold text-green-400 uppercase">BUGÜN ÇIKIŞ</div><div class="text-xl font-black text-green-700">${bugunCikislar.length}</div></div>
            `;

            let hgs = 0, kart = 0, nakit = 0;
            let html = `<table class="w-full text-[10px] text-left"><thead><tr class="text-gray-400 border-b"><th>PLAKA</th><th>ÖDEME</th><th>TUTAR</th></tr></thead><tbody>`;
            
            bugunCikislar.forEach(a => {
                if(a.odemeYontemi === 'HGS') hgs += a.tutar;
                else if(a.odemeYontemi === 'KART') kart += a.tutar;
                else if(a.odemeYontemi === 'NAKİT') nakit += a.tutar;
                html += `<tr class="border-b"><td class="py-2 font-bold">${a.plaka}</td><td class="text-gray-400">${a.odemeYontemi}</td><td class="font-black">${a.tutar} TL</td></tr>`;
            });

            document.getElementById('raporIcerik').innerHTML = html + `</tbody></table>`;
            document.getElementById('raporOzetBox').innerHTML = `
                <div class="flex justify-between text-xs mb-1"><span>HGS Toplam:</span><span class="font-bold text-blue-600">${hgs} TL</span></div>
                <div class="flex justify-between text-xs mb-1"><span>Kart Toplam:</span><span class="font-bold text-green-600">${kart} TL</span></div>
                <div class="flex justify-between text-xs mb-3"><span>Nakit Toplam:</span><span class="font-bold text-orange-600">${nakit} TL</span></div>
                <div class="flex justify-between items-center border-t pt-2 mt-2">
                    <span class="font-bold text-sm text-zinc-800 uppercase">GÜNLÜK CİRO:</span>
                    <span class="font-black text-xl text-zinc-900">${hgs+kart+nakit} TL</span>
                </div>
            `;
            
            document.getElementById('raporModal').classList.remove('hidden');
            switchTab('rapor');
        }

        function generatePDF() {
            const bugun = new Date().toLocaleDateString('tr-TR');
            const bugunCikislar = araclar.filter(a => a.durum === 'tamamlandi' && new Date(a.cikis).toLocaleDateString('tr-TR') === bugun);
            
            document.getElementById('pdfDateInfo').innerText = `Rapor Oluşturma Zamanı: ${bugun} ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            let hgs = 0, kart = 0, nakit = 0, rows = "";
            bugunCikislar.forEach(a => {
                if(a.odemeYontemi==='HGS') hgs+=a.tutar; else if(a.odemeYontemi==='KART') kart+=a.tutar; else if(a.odemeYontemi==='NAKİT') nakit+=a.tutar;
                rows += `<tr>
                    <td>${a.plaka}</td>
                    <td>${a.tip.toUpperCase()}</td>
                    <td>${new Date(a.giris).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                    <td>${new Date(a.cikis).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                    <td>${a.odemeYontemi}</td>
                    <td style="font-weight:bold;">${a.tutar} TL</td>
                </tr>`;
            });

            document.getElementById('pdfTableBody').innerHTML = rows || '<tr><td colspan="6" style="text-align:center;">Bugün henüz çıkış yapan araç yok.</td></tr>';
            document.getElementById('pdfSummarySection').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-size:12px; line-height:1.6;">
                        <div><b>HGS TOPLAM:</b> ${hgs} TL</div>
                        <div><b>KREDİ KARTI:</b> ${kart} TL</div>
                        <div><b>NAKİT TOPLAM:</b> ${nakit} TL</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px; font-weight:bold; color:#666;">GENEL TOPLAM</div>
                        <div style="font-size:24px; font-weight:900; color:#e11d48;">${hgs+kart+nakit} TL</div>
                    </div>
                </div>
            `;

            const element = document.getElementById('pdfReportLayout');
            element.style.display = 'block';
            
            const opt = { margin: 0.3, filename: `istay_rapor_${bugun}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            
            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        }

        // --- Diğer İşleyiciler ---
        function renderList() {
            const filtre = document.getElementById('plakaInput').value.toUpperCase();
            const liste = document.getElementById('aracListesi');
            liste.innerHTML = '';
            araclar.filter(a => a.plaka.includes(filtre)).forEach(arac => {
                const isComp = arac.durum === 'tamamlandi';
                const ucret = isComp ? arac.tutar : ucretHesapla(arac.giris, arac.tip);
                const farkMs = (isComp ? new Date(arac.cikis) : new Date()) - new Date(arac.giris);
                const isFree = (farkMs / 60000) <= 4;
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-2xl shadow-sm relative ${isComp ? 'completed-card' : 'park-card'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded ${arac.tip==='minibus'?'bg-blue-100 text-blue-600':'bg-rose-100 text-rose-600'}">${arac.tip.toUpperCase()}</span>
                            <h3 class="text-xl font-black text-zinc-800">${arac.plaka}</h3>
                        </div>
                        <button onclick="sil(${arac.id})" class="text-gray-300 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-[11px] font-bold ${isFree && !isComp ? 'text-green-500':'text-gray-400'}">
                            ${isComp ? 'Tahsil Edildi ('+arac.odemeYontemi+')' : sureHesapla(arac.giris) + (isFree ? ' - Ücretsiz' : '')}
                        </div>
                        <div class="text-3xl font-black ${isComp ? 'text-gray-300' : (ucret===0?'text-green-500':'text-rose-600')}">${ucret}<span class="text-xs ml-1">TL</span></div>
                    </div>
                    ${!isComp ? `
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="cikisYap(${arac.id}, 'HGS')" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-[10px] border border-blue-100">HGS</button>
                        <button onclick="cikisYap(${arac.id}, 'KART')" class="bg-green-50 text-green-600 py-3 rounded-xl font-bold text-[10px] border border-green-100">KART</button>
                        <button onclick="cikisYap(${arac.id}, 'NAKİT')" class="bg-orange-50 text-orange-600 py-3 rounded-xl font-bold text-[10px] border border-orange-100">NAKİT</button>
                    </div>` : ''}
                `;
                liste.prepend(card);
            });
        }

        function aracGiris() { const inp = document.getElementById('plakaInput'); const plaka = inp.value.trim().toUpperCase(); if(!plaka) return; araclar.push({ id: Date.now(), plaka, tip: seciliAracTipi, giris: new Date().toISOString(), cikis: null, odemeYontemi: null, tutar: 0, durum: 'aktif' }); localStorage.setItem('istay_park_data', JSON.stringify(araclar)); inp.value = ""; renderList(); }
        function cikisYap(id, yontem) { const a = araclar.find(x => x.id === id); a.tutar = ucretHesapla(a.giris, a.tip); a.cikis = new Date().toISOString(); a.odemeYontemi = yontem; a.durum = 'tamamlandi'; localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); }
        function sureHesapla(g) { const f = new Date() - new Date(g); return Math.floor(f/3600000) + "s " + Math.floor((f%3600000)/60000) + "dk"; }
        function setAracTipi(t) { seciliAracTipi = t; document.getElementById('type_oto').className = t === 'otomobil' ? 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white transition' : 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-gray-200 text-gray-500 transition'; document.getElementById('type_mini').className = t === 'minibus' ? 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-blue-600 bg-blue-600 text-white transition' : 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-gray-200 text-gray-500 transition'; }
        function switchTab(t) { ['rapor', 'fiyat', 'veri'].forEach(p => { document.getElementById('pane_'+p).classList.add('hidden'); document.getElementById('tab_'+p).className = "flex-1 py-4 font-bold text-xs text-gray-400 uppercase"; }); document.getElementById('pane_'+t).classList.remove('hidden'); document.getElementById('tab_'+t).className = "flex-1 py-4 font-bold text-xs border-b-2 border-rose-600 text-rose-600 uppercase"; if(t==='fiyat') tarifeInputlariniDoldur(); }
        function tarifeInputlariniDoldur() { const b = (tip, c) => { const cont = document.getElementById(c); cont.innerHTML = `<h4 class="col-span-2 font-black text-[10px] uppercase mb-1 text-gray-400">${tip}</h4>`; aktifTarife[tip].forEach((k, idx) => { cont.innerHTML += `<div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border text-[10px]"><span class="w-12 font-bold">${k.min}-${k.max}S:</span><input type="number" data-tip="${tip}" data-idx="${idx}" value="${k.ucret}" class="tarife-input w-full bg-white border rounded px-1 py-1 font-bold"></div>`; }); }; b('otomobil', 'oto_inputs'); b('minibus', 'mini_inputs'); }
        function tarifeleriKaydet() { document.querySelectorAll('.tarife-input').forEach(i => { aktifTarife[i.dataset.tip][i.dataset.idx].ucret = parseInt(i.value); }); localStorage.setItem('istay_tarifeler', JSON.stringify(aktifTarife)); alert("Fiyatlar kaydedildi."); }
        function raporuSifirla() { if(confirm("Tüm kayıtlar silinecek. Emin misiniz?")) { araclar = []; localStorage.setItem('istay_park_data', "[]"); renderList(); raporuKapat(); } }
        function sil(id) { if(confirm('Bu kaydı silmek istiyor musunuz?')) { araclar = araclar.filter(a => a.id !== id); localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); } }
        function veriyiDisaAktar() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(araclar)])); a.download = `yedek_${new Date().toLocaleDateString()}.txt`; a.click(); }
        function veriyiIceriAktar(e) { const r = new FileReader(); r.onload = (v) => { try { araclar = JSON.parse(v.target.result); localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); alert("Veriler başarıyla yüklendi."); } catch(err) { alert("Hatalı dosya formatı!"); } }; r.readAsText(e.target.files[0]); }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
        function raporuKapat() { document.getElementById('raporModal').classList.add('hidden'); }

        renderList();
        setInterval(renderList, 30000);
    </script>
</body>
</html>
