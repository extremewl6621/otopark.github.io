<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK - Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; }
        input:focus { outline: none; border-color: #e11d48 !important; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        .rapor-btn-top { background: #444; color: white; padding: 5px 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body class="pb-20">

    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <button onclick="raporuGoster()" class="rapor-btn-top"><i class="fas fa-chart-line"></i> Rapor</button>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 no-print">
            <div class="flex flex-row gap-2">
                <input type="text" id="plakaInput" placeholder="PLAKA GİRİNİZ" class="flex-1 min-w-0 px-4 py-3 border-2 border-gray-200 rounded-xl font-bold uppercase text-lg">
                <button onclick="aracGiris()" class="bg-[#e11d48] text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition">GİRİŞ</button>
            </div>
        </div>

        <div class="relative mb-4 no-print text-center">
            <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
            <input type="text" id="searchInput" onkeyup="renderList()" placeholder="Plaka ara..." class="w-full pl-11 pr-4 py-3.5 rounded-xl border-2 border-gray-900 shadow-sm focus:ring-2 focus:ring-rose-500 font-bold">
        </div>

        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-2xl overflow-hidden shadow-2xl p-6">
            <h3 class="font-bold text-gray-800 mb-4">Giriş Tarih/Saat Düzenle</h3>
            <input type="datetime-local" id="editDateTime" class="w-full border-2 border-gray-200 rounded-xl p-3 mb-4 font-bold">
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600 uppercase text-xs">İptal</button>
                <button id="saveEditBtn" class="flex-1 py-3 bg-rose-600 rounded-xl font-bold text-white uppercase text-xs shadow-lg">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="raporModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center no-print">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden max-h-[95vh] flex flex-col">
            <div class="bg-zinc-900 p-5 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg">Sistem Paneli</h2>
                <div class="flex gap-2">
                    <button onclick="pdfIndir()" class="bg-green-600 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="raporuKapat()" class="bg-zinc-800 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 bg-white">
                <div id="pdfContent">
                    <div id="raporIcerik" class="p-4"></div>
                    <div id="raporOzet" class="p-5 bg-gray-50 border-t"></div>
                </div>
                <div class="p-5 border-t bg-zinc-50">
                    <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Veri Yönetimi</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="veriyiDisaAktar()" class="bg-zinc-800 text-white py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> DIŞA AKTAR
                        </button>
                        <label class="bg-zinc-200 text-zinc-800 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 cursor-pointer text-center">
                            <i class="fas fa-upload"></i> İÇERİ AKTAR
                            <input type="file" id="importFile" class="hidden" onchange="veriyiIceriAktar(event)">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tarife = [ { min: 0, max: 1, ucret: 170 }, { min: 1, max: 2, ucret: 210 }, { min: 2, max: 4, ucret: 290 }, { min: 4, max: 6, ucret: 360 }, { min: 6, max: 8, ucret: 420 }, { min: 8, max: 12, ucret: 500 }, { min: 12, max: 24, ucret: 600 } ];
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let editingAracId = null;

        function sureHesapla(giris) {
            const fark = new Date() - new Date(giris);
            if(fark < 0) return "Gelecek Zaman";
            const saat = Math.floor(fark / (1000 * 60 * 60));
            const dk = Math.floor((fark / (1000 * 60)) % 60);
            return `${saat}s ${dk}dk`;
        }

        function ucretHesapla(girisTarihi) {
            const farkMs = new Date() - new Date(girisTarihi);
            if(farkMs <= 0) return 0;
            const toplamSaat = farkMs / (1000 * 60 * 60);
            const tamGun = Math.floor(toplamSaat / 24);
            const kalanSaat = toplamSaat % 24;
            let toplamUcret = tamGun * 600;
            if (kalanSaat > 0) {
                let ekUcret = 170; 
                for (let t of tarife) { if (kalanSaat > t.min && kalanSaat <= t.max) { ekUcret = t.ucret; break; } }
                toplamUcret += ekUcret;
            }
            return toplamUcret;
        }

        function aracGiris() {
            const input = document.getElementById('plakaInput');
            const plaka = input.value.trim().toUpperCase();
            if (!plaka) return;
            araclar.unshift({ id: Date.now(), plaka, giris: new Date().toISOString(), cikis: null, odemeYontemi: null, tutar: 0, durum: 'aktif' });
            dataKaydet();
            input.value = "";
        }

        function openEditModal(id) {
            editingAracId = id;
            const a = araclar.find(a => a.id === id);
            const girisTarihi = new Date(a.giris);
            
            // DateTime-local inputu için format: YYYY-MM-DDThh:mm
            const year = girisTarihi.getFullYear();
            const month = String(girisTarihi.getMonth() + 1).padStart(2, '0');
            const day = String(girisTarihi.getDate()).padStart(2, '0');
            const hours = String(girisTarihi.getHours()).padStart(2, '0');
            const minutes = String(girisTarihi.getMinutes()).padStart(2, '0');
            
            document.getElementById('editDateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('editModal').classList.remove('hidden');
            
            document.getElementById('saveEditBtn').onclick = function() {
                const newVal = document.getElementById('editDateTime').value;
                if(newVal) {
                    const d = new Date(newVal);
                    a.giris = d.toISOString();
                    dataKaydet();
                    closeEditModal();
                }
            };
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingAracId = null;
        }

        function cikisYap(id, yontem) {
            const a = araclar.find(a => a.id === id);
            a.tutar = ucretHesapla(a.giris);
            a.cikis = new Date().toISOString();
            a.odemeYontemi = yontem;
            a.durum = 'tamamlandi';
            dataKaydet();
        }

        function sil(id) { if(confirm('Kaydı sil?')) { araclar = araclar.filter(a => a.id !== id); dataKaydet(); } }

        function dataKaydet() {
            localStorage.setItem('istay_park_data', JSON.stringify(araclar));
            renderList();
        }

        function veriyiDisaAktar() {
            const dataStr = JSON.stringify(araclar, null, 2);
            const blob = new Blob([dataStr], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `istay_park_yedek.txt`;
            a.click();
        }

        function veriyiIceriAktar(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    araclar = [...data, ...araclar];
                    dataKaydet();
                    alert("Yedek başarıyla yüklendi!");
                } catch (err) { alert("Hata!"); }
            };
            reader.readAsText(file);
        }

        function renderList() {
            const liste = document.getElementById('aracListesi');
            const arama = document.getElementById('searchInput').value.toUpperCase();
            liste.innerHTML = '';
            araclar.filter(a => a.plaka.includes(arama)).forEach(arac => {
                const ucret = arac.durum === 'aktif' ? ucretHesapla(arac.giris) : arac.tutar;
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-2xl shadow-sm park-card relative ${arac.durum === 'tamamlandi' ? 'opacity-60' : ''}`;
                card.innerHTML = `
                    <button onclick="sil(${arac.id})" class="absolute top-4 right-4 text-gray-300 no-print"><i class="fas fa-trash"></i></button>
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[10px] font-bold ${arac.durum === 'aktif' ? 'text-rose-600' : 'text-gray-400'} uppercase">● ${arac.durum === 'aktif' ? 'İçeride' : 'Çıktı'}</span>
                            <h3 class="text-xl font-black text-zinc-800">${arac.plaka}</h3>
                            <p class="text-[11px] text-gray-500 font-bold mt-1">Süre: <span class="text-blue-600">${arac.durum === 'aktif' ? sureHesapla(arac.giris) : 'Tamamlandı'}</span></p>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-[9px] text-gray-400">Giriş: ${new Date(arac.giris).toLocaleString([], {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}</p>
                                ${arac.durum === 'aktif' ? `<button onclick="openEditModal(${arac.id})" class="text-blue-500 text-[10px] font-bold no-print uppercase underline"><i class="fas fa-edit"></i> Düzelt</button>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-[#e11d48]">${ucret} <small class="text-xs">TL</small></div>
                        </div>
                    </div>
                    ${arac.durum === 'aktif' ? `
                        <div class="grid grid-cols-3 gap-2 mt-4">
                            <button onclick="cikisYap(${arac.id}, 'HGS')" class="bg-blue-50 text-blue-600 py-2.5 rounded-lg font-bold text-xs border border-blue-100 uppercase">HGS</button>
                            <button onclick="cikisYap(${arac.id}, 'KART')" class="bg-green-50 text-green-600 py-2.5 rounded-lg font-bold text-xs border border-green-100 uppercase">Kart</button>
                            <button onclick="cikisYap(${arac.id}, 'NAKİT')" class="bg-orange-50 text-orange-600 py-2.5 rounded-lg font-bold text-xs border border-orange-100 uppercase">Nakit</button>
                        </div>` : `<div class="mt-2 text-[10px] text-gray-500 font-bold uppercase italic font-black">Ödeme: ${arac.odemeYontemi} | Çıkış: ${new Date(arac.cikis).toLocaleTimeString()}</div>`}
                `;
                liste.appendChild(card);
            });
        }

        function raporuGoster() {
            const bugunStr = new Date().toLocaleDateString('tr-TR');
            const raporListe = araclar.filter(a => new Date(a.giris).toLocaleDateString('tr-TR') === bugunStr || (a.cikis && new Date(a.cikis).toLocaleDateString('tr-TR') === bugunStr));
            let html = `<table class="w-full text-xs text-left"><thead><tr class="text-gray-400 border-b"><th>PLAKA</th><th>GİRİŞ</th><th>ÖDEME</th><th>TL</th></tr></thead><tbody>`;
            let hgs = 0, kart = 0, nakit = 0, aktif = 0;
            raporListe.forEach(a => {
                const u = a.durum === 'aktif' ? ucretHesapla(a.giris) : a.tutar;
                if(a.durum === 'aktif') aktif += u;
                else if(a.odemeYontemi === 'HGS') hgs += u;
                else if(a.odemeYontemi === 'KART') kart += u;
                else if(a.odemeYontemi === 'NAKİT') nakit += u;
                html += `<tr class="border-b"><td class="py-2 font-bold">${a.plaka}</td><td>${new Date(a.giris).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td><td class="font-bold uppercase">${a.durum === 'aktif' ? 'İçeride' : a.odemeYontemi}</td><td>${u}</td></tr>`;
            });
            document.getElementById('raporIcerik').innerHTML = html + `</tbody></table>`;
            document.getElementById('raporOzet').innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-[10px] font-bold uppercase text-gray-600">
                    <div>HGS: ${hgs} TL</div><div>KART: ${kart} TL</div><div>NAKİT: ${nakit} TL</div><div class="text-rose-600">AKTİF: ${aktif} TL</div>
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center"><span class="font-black text-sm uppercase">TOPLAM TAHSİLAT:</span><span class="text-2xl font-black text-[#e11d48]">${hgs+kart+nakit} TL</span></div>`;
            document.getElementById('raporModal').classList.remove('hidden');
        }

        function pdfIndir() {
            const element = document.getElementById('pdfContent');
            const opt = { margin: 10, filename: 'iSTAY_PARK_RAPOR.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        }

        function raporuKapat() { document.getElementById('raporModal').classList.add('hidden'); }
        renderList();
        setInterval(renderList, 30000); 
    </script>
</body>
</html>
