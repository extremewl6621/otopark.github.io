<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK AI PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { background: #0f172a; font-family: sans-serif; overflow: hidden; }
        #cameraOverlay { position: fixed; inset: 0; z-index: 100; display: none; background: #000; }
        #v { width: 100%; height: 100%; object-fit: cover; }
        
        /* TR Plaka Odak Çerçevesi */
        .plate-scanner { 
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 110px; border: 3px solid #3b82f6; border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); z-index: 110;
        }
        .tr-badge {
            position: absolute; left: 0; top: 0; bottom: 0; width: 35px;
            background: #003399; color: white; display: flex; align-items: center; 
            justify-content: center; font-weight: 900; font-size: 14px; border-radius: 8px 0 0 8px;
        }
        .scan-line {
            position: absolute; width: 100%; height: 3px; background: #3b82f6;
            top: 50%; box-shadow: 0 0 20px #3b82f6; animation: scan 1.5s ease-in-out infinite;
        }
        @keyframes scan { 0%, 100% { top: 10%; } 50% { top: 90%; } }
    </style>
</head>
<body>

    <div class="h-screen flex flex-col p-4 bg-slate-900 overflow-y-auto">
        <div class="mb-6 bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-700">
            <div class="relative mb-4">
                <input type="text" id="pInp" oninput="ara()" placeholder="PLAKA" class="w-full py-5 px-4 bg-slate-900 border-2 border-slate-700 rounded-2xl font-black text-4xl text-center text-white uppercase outline-none focus:border-blue-500 transition-all">
                <button onclick="acKamera()" class="absolute right-3 top-3 bottom-3 w-16 bg-blue-600 rounded-xl text-white shadow-lg active:scale-95 transition">
                    <i class="fas fa-camera-viewfinder text-2xl"></i>
                </button>
            </div>
            
            <div id="btnGiris" class="hidden">
                <div class="flex gap-2 mb-4">
                    <button id="tO" onclick="tipSec('otomobil')" class="flex-1 py-4 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600">OTOMOBİL</button>
                    <button id="tM" onclick="tipSec('minibus')" class="flex-1 py-4 rounded-xl font-bold text-slate-400 border-2 border-slate-700">MİNİBÜS</button>
                </div>
                <button onclick="kaydet()" class="w-full bg-emerald-500 text-white py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition">SİSTEME GİRİŞ YAP</button>
            </div>
        </div>

        <div id="liste" class="space-y-4 pb-24"></div>
    </div>

    <div id="cameraOverlay">
        <video id="v" autoplay playsinline></video>
        <div class="plate-scanner">
            <div class="tr-badge">TR</div>
            <div class="scan-line"></div>
        </div>
        
        <div class="absolute bottom-12 inset-x-0 flex flex-col items-center gap-6 z-[120]">
            <div id="status" class="text-white text-sm font-black bg-blue-600/90 px-6 py-2 rounded-full uppercase shadow-xl">PLAKAYI HİZALAYIN</div>
            <div class="flex gap-12 items-center">
                <button onclick="kapatKamera()" class="text-white/60 font-black uppercase text-sm tracking-widest">İPTAL</button>
                <button onclick="cek()" class="w-20 h-20 bg-white rounded-full border-8 border-blue-600 flex items-center justify-center shadow-2xl active:scale-90 transition">
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-camera text-2xl text-white"></i>
                    </div>
                </button>
                <div class="w-12"></div>
            </div>
        </div>
        <canvas id="c" style="display:none;"></canvas>
    </div>

    <script>
        let araclar = JSON.parse(localStorage.getItem('istay_park_v9')) || [];
        let seciliTip = 'otomobil';
        let akis = null;

        async function acKamera() {
            try {
                akis = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 } } });
                document.getElementById('v').srcObject = akis;
                document.getElementById('cameraOverlay').style.display = 'block';
            } catch (e) { 
                alert("Kamera izni reddedildi. Lütfen tarayıcı ayarlarından kamera iznini 'İzin Ver' olarak güncelleyin."); 
            }
        }

        function kapatKamera() {
            if(akis) akis.getTracks().forEach(t => t.stop());
            document.getElementById('cameraOverlay').style.display = 'none';
        }

        async function cek() {
            const video = document.getElementById('v');
            const canvas = document.getElementById('c');
            const ctx = canvas.getContext('2d');
            
            const oran = video.videoWidth / video.clientWidth;
            const w = 85 * (video.clientWidth / 100) * oran;
            const h = 110 * oran;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = w; canvas.height = h;
            ctx.filter = 'contrast(1.2) grayscale(1)'; 
            ctx.drawImage(video, x, y, w, h, 0, 0, w, h);
            
            document.getElementById('status').innerText = "TR PLAKA OKUNUYOR...";
            analizEt(canvas.toDataURL('image/jpeg', 0.9));
        }

        async function analizEt(src) {
            try {
                const worker = await Tesseract.createWorker('eng');
                const { data: { text } } = await worker.recognize(src);
                await worker.terminate();

                // TR PLAKA REGEX: İl kodu (2 rakam) + Harfler + Sayılar
                const temizMetin = text.toUpperCase().replace(/[^A-Z0-9]/g, "");
                const plakaMatch = temizMetin.match(/([0-8][0-9][A-Z]{1,3}[0-9]{2,4})/);
                
                if(plakaMatch) {
                    document.getElementById('pInp').value = plakaMatch[0];
                    kapatKamera();
                    ara();
                } else {
                    document.getElementById('status').innerText = "TEKRAR DENEYİN";
                    alert("Plaka tam okunamadı. Lütfen çerçeveyi plakaya tam oturtun.");
                }
            } catch (e) { alert("Sistem Meşgul, Tekrar Deneyin"); }
        }

        function ara() {
            const val = document.getElementById('pInp').value.toUpperCase();
            const listeDiv = document.getElementById('liste');
            const btnGiris = document.getElementById('btnGiris');
            listeDiv.innerHTML = '';

            const icerideMi = araclar.find(a => a.p === val && a.d === 'aktif');
            btnGiris.className = icerideMi ? 'hidden' : 'block';

            araclar.filter(a => a.p.includes(val)).sort((a,b) => (a.d === 'aktif' ? -1 : 1)).forEach(a => {
                const aktif = a.d === 'aktif';
                const kart = document.createElement('div');
                kart.className = `p-6 rounded-3xl ${aktif ? 'bg-white border-l-8 border-blue-600' : 'bg-slate-800 opacity-50 border-l-8 border-slate-600'} relative shadow-xl`;
                kart.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">${a.t}</span>
                            <h2 class="text-3xl font-black ${aktif?'text-slate-900':'text-slate-400'}">${a.p}</h2>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-black text-rose-600">${aktif ? '170' : a.ucret} TL</span>
                        </div>
                    </div>
                    ${aktif ? `
                    <div class="grid grid-cols-3 gap-2 mt-5">
                        <button onclick="cikis(${a.id},'HGS')" class="bg-blue-600 text-white py-4 rounded-2xl font-bold text-xs shadow-md active:scale-95">HGS</button>
                        <button onclick="cikis(${a.id},'KART')" class="bg-slate-900 text-white py-4 rounded-2xl font-bold text-xs shadow-md active:scale-95">KART</button>
                        <button onclick="cikis(${a.id},'NAKİT')" class="bg-amber-500 text-white py-4 rounded-2xl font-bold text-xs shadow-md active:scale-95">NAKİT</button>
                    </div>` : `<div class="mt-3 text-center text-xs font-bold text-slate-500 italic">ÇIKIŞ YAPILDI (${a.odeme})</div>`}
                    <button onclick="sil(${a.id})" class="absolute top-2 right-4 text-slate-300 text-lg"><i class="fas fa-times-circle"></i></button>
                `;
                listeDiv.appendChild(kart);
            });
        }

        function kaydet() {
            const p = document.getElementById('pInp').value.trim().toUpperCase();
            if(!p) return;
            araclar.push({ id: Date.now(), p, t: seciliTip, g: new Date().toISOString(), d: 'aktif' });
            localStorage.setItem('istay_park_v9', JSON.stringify(araclar));
            document.getElementById('pInp').value = "";
            ara();
        }

        function cikis(id, odeme) {
            const a = araclar.find(x => x.id === id);
            a.ucret = '170'; a.odeme = odeme; a.d = 'bitti';
            localStorage.setItem('istay_park_v9', JSON.stringify(araclar));
            document.getElementById('pInp').value = "";
            ara();
        }

        function sil(id) { if(confirm('Bu kaydı silmek istediğinize emin misiniz?')) { araclar = araclar.filter(x => x.id !== id); localStorage.setItem('istay_park_v9', JSON.stringify(araclar)); ara(); } }
        function tipSec(v) { 
            seciliTip = v; 
            document.getElementById('tO').className = v === 'otomobil' ? 'flex-1 py-4 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600' : 'flex-1 py-4 rounded-xl font-bold text-slate-400 border-2 border-slate-700';
            document.getElementById('tM').className = v === 'minibus' ? 'flex-1 py-4 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600' : 'flex-1 py-4 rounded-xl font-bold text-slate-400 border-2 border-slate-700';
        }

        ara();
    </script>
</body>
</html>
