<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.0/dist/tesseract.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; transition: all 0.3s; position: relative; background: white; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.8; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        
        /* PDF tasarımı için gizli ama erişilebilir alan */
        #pdfTemplate { width: 100%; background: white; padding: 30px; color: black; display: none; position: absolute; left: -9999px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { background: #1a1a1a; color: white; border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
        .pdf-table td { border: 1px solid #ddd; padding: 8px; font-size: 11px; }

        #cameraModal, #autoExitModal { background: rgba(0,0,0,0.9); z-index: 100; }
        .scan-focus-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 90px; border: 2px solid #22c55e; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #22c55e; box-shadow: 0 0 15px #22c55e; animation: scanAnim 2s infinite; }
        @keyframes scanAnim { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="pb-20">

    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <div class="flex gap-2">
            <button onclick="kamerayiAc()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2"><i class="fas fa-camera"></i> TARA</button>
            <button onclick="raporuGoster()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg"><i class="fas fa-chart-pie mr-1"></i> RAPORLAR</button>
        </div>
    </div>

    <div id="pdfTemplate">
        <div style="border-bottom: 5px solid #e11d48; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="font-size: 28px; font-weight: 900; margin: 0;">iSTAY PARK ÖZETİ</h1>
            <p id="pdfDate" style="margin: 5px 0; color: #444; font-weight: bold;"></p>
        </div>
        <table class="pdf-table">
            <thead><tr><th>PLAKA</th><th>ARAÇ TİPİ</th><th>GİRİŞ SAATİ</th><th>ÇIKIŞ SAATİ</th><th>ÖDEME</th><th>TUTAR</th></tr></thead>
            <tbody id="pdfBody"></tbody>
        </table>
        <div id="pdfSummaryArea" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;"></div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-6 no-print">
            <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA GİRİN VEYA ARA" class="w-full px-4 py-4 border-2 border-gray-100 rounded-2xl font-black uppercase text-2xl mb-4 text-center focus:border-rose-500 outline-none transition-all">
            <div class="flex gap-3 mb-4">
                <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white shadow-md">OTOMOBİL</button>
                <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-gray-100 text-gray-500">MİNİBÜS</button>
            </div>
            <button onclick="aracGiris()" class="w-full bg-zinc-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">GİRİŞİ KAYDET</button>
        </div>
        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="font-black text-zinc-800 mb-4 text-center uppercase">Giriş Saati Düzelt</h3>
            <input type="datetime-local" id="editDateTime" class="w-full border-2 border-gray-100 rounded-2xl p-4 mb-4 font-bold outline-none focus:border-rose-500">
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold text-gray-400 uppercase text-xs">İptal</button>
                <button id="saveEditBtn" class="flex-1 py-4 bg-zinc-900 rounded-2xl font-bold text-white uppercase text-xs shadow-lg">Güncelle</button>
            </div>
        </div>
    </div>

    <div id="cameraModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden relative">
            <div class="p-6">
                <div class="relative rounded-2xl overflow-hidden bg-black aspect-video mb-4">
                    <video id="cameraVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                    <div class="scan-focus-box"><div class="scan-line"></div></div>
                </div>
                <div id="ocrStatus" class="text-center font-bold text-gray-500 mb-4 text-xs uppercase">Plakayı yeşil alana getirin</div>
                <button onclick="fotografCek()" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black text-lg shadow-xl">PLAKAYI OKU</button>
                <button onclick="kamerayiKapat()" class="w-full mt-2 text-gray-400 font-bold py-2">KAPAT</button>
            </div>
        </div>
    </div>

    <div id="autoExitModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="bg-zinc-900 p-6 text-white text-center">
                <h2 id="exitPlaka" class="text-3xl font-black tracking-tighter">-</h2>
                <p id="exitSure" class="text-rose-500 font-bold text-xs italic">Süre hesaplanıyor...</p>
            </div>
            <div class="p-8">
                <div class="text-center mb-8">
                    <span id="exitTutar" class="text-6xl font-black text-zinc-900">0</span><span class="text-2xl font-black ml-1 text-zinc-900">TL</span>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="otomatikCikisYap('NAKİT')" class="w-full py-5 bg-amber-500 text-white rounded-2xl font-black flex justify-between px-6 items-center">NAKİT <i class="fas fa-money-bill-wave"></i></button>
                    <button onclick="otomatikCikisYap('KART')" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black flex justify-between px-6 items-center">KREDİ KARTI <i class="fas fa-credit-card"></i></button>
                    <button onclick="otomatikCikisYap('HGS')" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black flex justify-between px-6 items-center">HGS SİSTEMİ <i class="fas fa-rss"></i></button>
                </div>
                <button onclick="document.getElementById('autoExitModal').classList.add('hidden')" class="w-full mt-6 text-gray-400 font-bold">VAZGEÇ</button>
            </div>
        </div>
    </div>

    <div id="raporModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-end sm:items-center justify-center no-print">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden max-h-[95vh] flex flex-col">
            <div class="bg-zinc-900 p-6 text-white flex justify-between items-center">
                <h2 id="modalTitle" class="font-black text-xl">Finansal Özet</h2>
                <div class="flex gap-2">
                    <button onclick="generatePDF()" class="bg-green-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-file-pdf text-xl"></i></button>
                    <button onclick="raporuKapat()" class="bg-zinc-800 w-12 h-12 rounded-2xl flex items-center justify-center active:scale-90"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 p-4 bg-gray-50">
                <div id="raporGorunumu">
                    <div id="ozetKartlari" class="grid grid-cols-3 gap-2 mb-6"></div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                        <h3 class="text-[10px] font-black text-gray-400 mb-3 uppercase tracking-wider">İşlem Geçmişi</h3>
                        <div id="raporTablo" class="space-y-2 max-h-60 overflow-auto"></div>
                    </div>
                    <div id="netCiroBox" class="bg-zinc-900 rounded-2xl p-5 text-white flex justify-between items-center shadow-2xl"></div>
                </div>
                <div id="tarifeGorunumu" class="hidden">
                    <div id="oto_fiyat_list" class="grid grid-cols-2 gap-2 mb-6"></div>
                    <div id="mini_fiyat_list" class="grid grid-cols-2 gap-2 mb-6"></div>
                    <button onclick="tarifeleriKaydet()" class="w-full bg-zinc-900 text-white py-4 rounded-xl font-black uppercase mb-4">Fiyatları Uygula</button>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-2">
                    <button id="btnTarife" onclick="toggleView('tarife')" class="bg-white border py-3 rounded-xl font-bold text-[10px] uppercase">Fiyat Düzenle</button>
                    <button onclick="raporuSifirla()" class="bg-rose-50 text-rose-600 border border-rose-100 py-3 rounded-xl font-bold text-[10px] uppercase">Sistemi Sıfırla</button>
                    <button onclick="veriyiDisaAktar()" class="bg-zinc-800 text-white py-3 rounded-xl font-bold text-[10px] uppercase">Dışa Aktar</button>
                    <label class="bg-zinc-100 text-zinc-600 py-3 rounded-xl font-bold text-[10px] uppercase text-center cursor-pointer border border-zinc-200">
                        İçe Aktar <input type="file" id="importFile" class="hidden" onchange="veriyiIceriAktar(event)">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tarife ve Veri Yapısı
        let varsayilanTarife = {
            otomobil: [ { min: 0, max: 1, ucret: 170 }, { min: 1, max: 2, ucret: 210 }, { min: 2, max: 4, ucret: 290 }, { min: 4, max: 6, ucret: 360 }, { min: 6, max: 8, ucret: 420 }, { min: 8, max: 12, ucret: 500 }, { min: 12, max: 24, ucret: 600 } ],
            minibus: [ { min: 0, max: 1, ucret: 250 }, { min: 1, max: 2, ucret: 300 }, { min: 2, max: 4, ucret: 400 }, { min: 4, max: 6, ucret: 500 }, { min: 6, max: 8, ucret: 600 }, { min: 8, max: 12, ucret: 750 }, { min: 12, max: 24, ucret: 900 } ]
        };
        let aktifTarife = JSON.parse(localStorage.getItem('istay_tarifeler')) || varsayilanTarife;
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let seciliAracTipi = 'otomobil';
        let cameraStream = null;
        let aktifExitId = null;

        // --- GÜNCELLENMİŞ HESAPLAMA (ZAMAN HATASI ÇÖZÜLDÜ) ---
        function ucretHesapla(girisTarihi, tip) {
            const giris = new Date(girisTarihi);
            const simdi = new Date();
            // Mutlak değer alarak geçmişe dönük saat girişinde negatif süreyi engelliyoruz
            const farkMs = Math.abs(simdi - giris);
            const farkDakika = farkMs / 60000;

            if (farkDakika <= 4) return 0; // İlk 4 dakika ücretsiz

            const toplamSaat = farkMs / 3600000;
            const tamGun = Math.floor(toplamSaat / 24);
            const kalanSaat = toplamSaat % 24;
            
            const t = aktifTarife[tip] || aktifTarife.otomobil;
            let ucret = tamGun * t[t.length - 1].ucret;

            if (kalanSaat > 0) {
                let ekUcret = t[0].ucret; 
                for (let k of t) {
                    if (kalanSaat > k.min && kalanSaat <= k.max) {
                        ekUcret = k.ucret;
                        break;
                    }
                }
                ucret += ekUcret;
            }
            return ucret;
        }

        // --- GÜNCELLENMİŞ PDF FONKSİYONU (BOŞ EKRAN ÇÖZÜLDÜ) ---
        function generatePDF() { 
            const bugun = new Date().toLocaleDateString('tr-TR'); 
            const bugunCikislar = araclar.filter(a => a.durum === 'tamamlandi' && new Date(a.cikis).toLocaleDateString('tr-TR') === bugun); 
            
            const pdfEl = document.getElementById('pdfTemplate');
            const pdfBody = document.getElementById('pdfBody');
            const pdfDate = document.getElementById('pdfDate');
            const pdfSummaryArea = document.getElementById('pdfSummaryArea');

            pdfDate.innerText = "Rapor Tarihi: " + bugun + " " + new Date().toLocaleTimeString(); 
            
            let hgs = 0, kart = 0, nakit = 0, rows = ""; 
            bugunCikislar.forEach(a => { 
                if(a.odemeYontemi === 'HGS') hgs += a.tutar; 
                else if(a.odemeYontemi === 'KART') kart += a.tutar; 
                else if(a.odemeYontemi === 'NAKİT') nakit += a.tutar; 
                rows += `<tr><td>${a.plaka}</td><td>${a.tip.toUpperCase()}</td><td>${new Date(a.giris).toLocaleTimeString()}</td><td>${new Date(a.cikis).toLocaleTimeString()}</td><td>${a.odemeYontemi}</td><td>${a.tutar} TL</td></tr>`; 
            }); 

            pdfBody.innerHTML = rows || '<tr><td colspan="6" style="text-align:center;">Bugün henüz işlem yapılmadı.</td></tr>'; 
            pdfSummaryArea.innerHTML = `
                <table style="width: 100%; border: 0;">
                    <tr>
                        <td style="width: 50%; font-size: 14px; line-height: 1.8;">
                            <b>HGS TOPLAM:</b> ${hgs} TL<br>
                            <b>KART TOPLAM:</b> ${kart} TL<br>
                            <b>NAKİT TOPLAM:</b> ${nakit} TL
                        </td>
                        <td style="text-align: right; background: #f4f4f4; padding: 20px; border-radius: 10px;">
                            <span style="font-size: 12px; color: #666; font-weight: bold; text-transform: uppercase;">Toplam Tahsilat</span><br>
                            <span style="font-size: 32px; font-weight: 900; color: #e11d48;">${hgs+kart+nakit} TL</span>
                        </td>
                    </tr>
                </table>`; 

            // Çözüm: Görünür yap, render et, PDF al ve tekrar gizle
            pdfEl.style.display = 'block';
            pdfEl.style.position = 'static';
            pdfEl.style.left = 'auto';

            const opt = {
                margin: 0.5,
                filename: `istay_rapor_${bugun}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(pdfEl).save().then(() => {
                pdfEl.style.display = 'none';
                pdfEl.style.position = 'absolute';
                pdfEl.style.left = '-9999px';
            });
        }

        // --- GÜNCELLENMİŞ SAAT DÜZENLEME ---
        function openEditModal(id) { 
            const a = araclar.find(a => a.id === id); 
            if(a.durum === 'tamamlandi') return; 
            const g = new Date(a.giris); 
            // Input'a uygun tarih formatı
            document.getElementById('editDateTime').value = new Date(g.getTime() - g.getTimezoneOffset() * 60000).toISOString().slice(0, 16); 
            document.getElementById('editModal').classList.remove('hidden'); 
            
            document.getElementById('saveEditBtn').onclick = () => { 
                const yeniTarih = new Date(document.getElementById('editDateTime').value);
                a.giris = yeniTarih.toISOString(); 
                localStorage.setItem('istay_park_data', JSON.stringify(araclar)); 
                closeEditModal();
                renderList(); // Listeyi anında yenileyerek yeni fiyatı göster
            }; 
        }

        // Diğer Fonksiyonlar (Aynen Kalacak)
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
        function setAracTipi(t) { seciliAracTipi = t; renderUI(); }
        function renderUI() {
            document.getElementById('type_oto').className = seciliAracTipi === 'otomobil' ? 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white shadow-md' : 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-gray-100 text-gray-500';
            document.getElementById('type_mini').className = seciliAracTipi === 'minibus' ? 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-blue-600 bg-blue-600 text-white shadow-md' : 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-gray-100 text-gray-500';
        }

        function renderList() {
            const filtre = document.getElementById('plakaInput').value.toUpperCase();
            const liste = document.getElementById('aracListesi');
            liste.innerHTML = '';
            let aktifler = araclar.filter(a => a.durum === 'aktif' && a.plaka.includes(filtre)).sort((a, b) => a.plaka.localeCompare(b.plaka));
            let tamamlananlar = araclar.filter(a => a.durum === 'tamamlandi' && a.plaka.includes(filtre)).sort((a, b) => new Date(b.cikis) - new Date(a.cikis));
            
            [...aktifler, ...tamamlananlar].forEach(arac => {
                const isComp = arac.durum === 'tamamlandi';
                const ucret = isComp ? arac.tutar : ucretHesapla(arac.giris, arac.tip);
                const card = document.createElement('div');
                card.className = `p-5 rounded-3xl shadow-sm relative ${isComp ? 'completed-card bg-white' : 'park-card bg-white'}`;
                card.innerHTML = `
                    <button onclick="sil(${arac.id})" class="absolute top-4 right-4 text-gray-300 p-2 z-10"><i class="fas fa-trash"></i></button>
                    <div class="flex justify-between items-start pr-10">
                        <div>
                            <span class="text-[8px] font-black px-2 py-1 rounded-lg uppercase ${arac.tip==='minibus'?'bg-blue-100 text-blue-600':'bg-rose-100 text-rose-600'}">${arac.tip}</span>
                            <h3 class="text-2xl font-black text-zinc-800 mt-1">${arac.plaka}</h3>
                            <div onclick="openEditModal(${arac.id})" class="text-[10px] font-bold text-gray-400 mt-1 cursor-pointer">Giriş: ${new Date(arac.giris).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <span class="underline">Düzelt</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black ${isComp ? 'text-gray-400' : (ucret===0?'text-green-500':'text-rose-600')}">${ucret}<small class="text-xs ml-0.5">TL</small></div>
                            <div class="text-[10px] font-bold uppercase">${isComp ? 'ÖDENDİ' : sureHesapla(arac.giris)}</div>
                        </div>
                    </div>
                    ${!isComp ? `<div class="grid grid-cols-3 gap-2 mt-4"><button onclick="cikisYap(${arac.id}, 'HGS')" class="bg-blue-600 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">HGS</button><button onclick="cikisYap(${arac.id}, 'KART')" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">KART</button><button onclick="cikisYap(${arac.id}, 'NAKİT')" class="bg-amber-500 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg">NAKİT</button></div>` : ''}`;
                liste.appendChild(card);
            });
        }

        function aracGiris() { 
            const inp = document.getElementById('plakaInput'); 
            const plaka = inp.value.trim().toUpperCase(); 
            if(!plaka) return; 
            const varMi = araclar.some(a => a.plaka === plaka && a.durum === 'aktif');
            if(varMi) { alert("Bu araç zaten içeride!"); return; }
            araclar.push({ id: Date.now(), plaka, tip: seciliAracTipi, giris: new Date().toISOString(), cikis: null, odemeYontemi: null, tutar: 0, durum: 'aktif' }); 
            localStorage.setItem('istay_park_data', JSON.stringify(araclar)); 
            inp.value = ""; renderList(); 
        }

        function cikisYap(id, yontem) { const a = araclar.find(x => x.id === id); a.tutar = ucretHesapla(a.giris, a.tip); a.cikis = new Date().toISOString(); a.odemeYontemi = yontem; a.durum = 'tamamlandi'; localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); }
        function sureHesapla(g) { const f = Math.abs(new Date() - new Date(g)); return Math.floor(f/3600000) + "s " + Math.floor((f%3600000)/60000) + "dk"; }
        function sil(id) { if(confirm('Silinsin mi?')) { araclar = araclar.filter(a => a.id !== id); localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); } }
        function raporuKapat() { document.getElementById('raporModal').classList.add('hidden'); }
        function raporuGoster() { 
            const bugun = new Date().toLocaleDateString('tr-TR'); 
            const bugunCikislar = araclar.filter(a => a.durum === 'tamamlandi' && new Date(a.cikis).toLocaleDateString('tr-TR') === bugun); 
            let hgs = 0, kart = 0, nakit = 0, tabloHtml = ""; 
            bugunCikislar.forEach(a => { 
                if(a.odemeYontemi === 'HGS') hgs += a.tutar; 
                else if(a.odemeYontemi === 'KART') kart += a.tutar; 
                else if(a.odemeYontemi === 'NAKİT') nakit += a.tutar; 
                tabloHtml += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100"><span class="font-bold text-xs">${a.plaka}</span><span class="text-[9px] font-bold text-gray-400">${a.odemeYontemi}</span><span class="font-black text-xs">${a.tutar} TL</span></div>`; 
            }); 
            document.getElementById('ozetKartlari').innerHTML = `<div class="bg-blue-600 p-4 rounded-2xl text-white shadow-lg text-center"><div class="text-[8px] font-bold opacity-70">HGS</div><div class="text-lg font-black">${hgs}</div></div><div class="bg-emerald-600 p-4 rounded-2xl text-white shadow-lg text-center"><div class="text-[8px] font-bold opacity-70">KART</div><div class="text-lg font-black">${kart}</div></div><div class="bg-amber-500 p-4 rounded-2xl text-white shadow-lg text-center"><div class="text-[8px] font-bold opacity-70">NAKİT</div><div class="text-lg font-black">${nakit}</div></div>`; 
            document.getElementById('raporTablo').innerHTML = tabloHtml || `<p class="text-center text-gray-400 py-4 text-xs font-bold">İŞLEM YOK</p>`; 
            document.getElementById('netCiroBox').innerHTML = `<div><h4 class="text-[10px] font-bold text-gray-400 uppercase">Toplam Tahsilat</h4><p class="text-2xl font-black">${hgs+kart+nakit} TL</p></div><i class="fas fa-wallet text-3xl opacity-20"></i>`; 
            document.getElementById('raporModal').classList.remove('hidden'); 
            toggleView('rapor'); 
        }

        function toggleView(v) { const isT = v === 'tarife'; document.getElementById('raporGorunumu').style.display = isT ? 'none' : 'block'; document.getElementById('tarifeGorunumu').style.display = isT ? 'block' : 'none'; if(isT) renderTarifeInputs(); }
        function renderTarifeInputs() { const gen = (tip, target) => { let html = `<h4 class="col-span-2 font-black text-[10px] text-gray-400 uppercase mb-2">${tip} Fiyatlar</h4>`; aktifTarife[tip].forEach((k, i) => { html += `<div class="bg-white p-2 rounded-xl border flex items-center justify-between"><span class="text-[10px] font-bold">${k.min}-${k.max}S:</span><input type="number" value="${k.ucret}" class="fiyat-input w-16 text-right font-black text-rose-600 outline-none" data-tip="${tip}" data-idx="${i}"></div>`; }); document.getElementById(target).innerHTML = html; }; gen('otomobil', 'oto_fiyat_list'); gen('minibus', 'mini_fiyat_list'); }
        function tarifeleriKaydet() { document.querySelectorAll('.fiyat-input').forEach(input => { aktifTarife[input.dataset.tip][input.dataset.idx].ucret = parseInt(input.value); }); localStorage.setItem('istay_tarifeler', JSON.stringify(aktifTarife)); alert("Fiyatlar güncellendi!"); toggleView('rapor'); renderList(); }
        function veriyiDisaAktar() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(araclar)], {type: "text/plain"})); a.download = `istay_yedek_${new Date().toLocaleDateString()}.txt`; a.click(); }
        function veriyiIceriAktar(e) { const r = new FileReader(); r.onload = (v) => { try { const data = JSON.parse(v.target.result); if(Array.isArray(data)) { araclar = data; localStorage.setItem('istay_park_data', JSON.stringify(araclar)); renderList(); alert("Yedek yüklendi!"); raporuKapat(); } } catch(err) { alert("Dosya hatalı!"); } }; r.readAsText(e.target.files[0]); }
        function raporuSifirla() { if(confirm("TÜM VERİLER SIFIRLANACAK?")) { araclar = []; localStorage.setItem('istay_park_data', "[]"); renderList(); raporuKapat(); } }

        // Kamera Fonksiyonları (Mevcut mantık korunmuştur)
        async function kamerayiAc() { document.getElementById('cameraModal').classList.remove('hidden'); try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 } } }); document.getElementById('cameraVideo').srcObject = cameraStream; } catch (err) { alert("Kamera izni gerekli!"); kamerayiKapat(); } }
        function kamerayiKapat() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; } document.getElementById('cameraModal').classList.add('hidden'); }
        async function fotografCek() { const video = document.getElementById('cameraVideo'); const status = document.getElementById('ocrStatus'); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const cw = video.videoWidth * 0.7; const ch = 140; const sx = (video.videoWidth - cw) / 2; const sy = (video.videoHeight - ch) / 2; canvas.width = cw; canvas.height = ch; ctx.filter = 'grayscale(1) contrast(2)'; ctx.drawImage(video, sx, sy, cw, ch, 0, 0, cw, ch); status.textContent = "PLAKA ANALİZ EDİLİYOR..."; try { const { data: { text } } = await Tesseract.recognize(canvas, 'eng'); let raw = text.toUpperCase().replace(/[^A-Z0-9]/g, ''); const match = raw.match(/[0-9]{2}[A-Z]{1,3}[0-9]{2,4}/); if (match) { status.textContent = "BULDUM: " + match[0]; setTimeout(() => { kamerayiKapat(); akilliIslem(match[0]); }, 600); } else { status.textContent = "OKUNAMADI"; } } catch (err) { status.textContent = "HATA"; } }
        function akilliIslem(plaka) { const arac = araclar.find(a => a.plaka === plaka && a.durum === 'aktif'); if (arac) { aktifExitId = arac.id; document.getElementById('exitPlaka').textContent = arac.plaka; document.getElementById('exitSure').textContent = sureHesapla(arac.giris); document.getElementById('exitTutar').textContent = ucretHesapla(arac.giris, arac.tip); document.getElementById('autoExitModal').classList.remove('hidden'); } else { document.getElementById('plakaInput').value = plaka; renderList(); } }
        function otomatikCikisYap(y) { cikisYap(aktifExitId, y); document.getElementById('autoExitModal').classList.add('hidden'); }

        renderList();
        setInterval(renderList, 30000);
    </script>
</body>
</html>
