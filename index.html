<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO - Plaka Tanımalı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; overflow-x: hidden; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; transition: all 0.3s; position: relative; background: white; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.8; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        
        /* Kamera Alanı */
        #cameraContainer { display: none; position: fixed; inset: 0; background: black; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay { 
            position: absolute; 
            border: 3px solid #e11d48; 
            width: 85%; 
            height: 120px; 
            border-radius: 15px; 
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); 
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scan-line {
            width: 100%;
            height: 2px;
            background: #e11d48;
            box-shadow: 0 0 15px #e11d48;
            position: absolute;
            animation: scanAnim 2s infinite linear;
        }
        @keyframes scanAnim {
            0% { top: 0; }
            100% { top: 100%; }
        }

        #pdfTemplate { width: 100%; background: white; padding: 20px; color: black; display: none; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { background: #1a1a1a; color: white; border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
        .pdf-table td { border: 1px solid #ddd; padding: 8px; font-size: 11px; }
    </style>
</head>
<body class="pb-20">

    <div id="cameraContainer">
        <video id="videoFeed" autoplay playsinline></video>
        <div class="scan-overlay">
            <div class="scan-line"></div>
        </div>
        <div id="scanStatus" class="absolute top-10 text-white font-bold bg-black/50 px-6 py-2 rounded-full text-sm">PLAKAYI KUTUYA ORTALAYIN</div>
        <div class="absolute bottom-10 flex gap-6">
            <button onclick="stopCamera()" class="bg-zinc-800 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-2xl"><i class="fas fa-times text-2xl"></i></button>
            <button onclick="captureImage()" class="bg-rose-600 text-white w-20 h-20 rounded-full flex items-center justify-center shadow-2xl border-4 border-white"><i class="fas fa-camera text-3xl"></i></button>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black/95 z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-[40px] overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-eye text-2xl"></i>
                </div>
                <h3 class="text-zinc-400 font-bold text-[10px] mb-2 uppercase tracking-widest">Okunan Plaka</h3>
                <input type="text" id="confirmedPlate" class="w-full text-4xl font-black text-center border-b-4 border-rose-500 py-2 mb-6 uppercase focus:outline-none text-zinc-800">
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 py-4 bg-zinc-100 rounded-2xl font-bold text-zinc-500 text-xs">İPTAL</button>
                    <button onclick="finalProcessPlate()" class="flex-1 py-4 bg-rose-600 rounded-2xl font-bold text-white text-xs shadow-lg shadow-rose-200">ONAYLA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scanExitModal" class="hidden fixed inset-0 bg-black/90 z-[120] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl">
            <div class="bg-rose-600 p-8 text-center text-white">
                <div class="text-[10px] font-bold opacity-70 uppercase tracking-widest mb-1">Araç Çıkış Detayı</div>
                <h2 id="exitPlaka" class="text-5xl font-black italic">-- --- --</h2>
            </div>
            <div class="p-8 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-2xl">
                        <span class="block text-[9px] text-gray-400 font-bold uppercase">Giriş Saati</span>
                        <span id="exitGirisSaat" class="font-black text-zinc-800">--:--</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-2xl">
                        <span class="block text-[9px] text-gray-400 font-bold uppercase">Geçen Süre</span>
                        <span id="exitSure" class="font-black text-zinc-800">--</span>
                    </div>
                </div>
                <div class="text-center py-2">
                    <div class="text-gray-400 text-[10px] font-bold uppercase mb-1">Tahsil Edilecek</div>
                    <div id="exitTutar" class="text-6xl font-black text-zinc-900">0<small class="text-xl">TL</small></div>
                </div>
                <div class="grid grid-cols-1 gap-3 pt-2">
                    <button id="exitBtnHGS" class="bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg">HGS İLE TAHSİL ET</button>
                    <button id="exitBtnKART" class="bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg">KREDİ KARTI</button>
                    <button id="exitBtnNAKIT" class="bg-amber-500 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg">NAKİT ÖDEME</button>
                </div>
                <button onclick="closeScanExitModal()" class="w-full text-zinc-400 font-bold py-2 text-[10px] uppercase tracking-widest mt-2">İşlemi İptal Et</button>
            </div>
        </div>
    </div>

    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <button onclick="raporuGoster()" class="bg-rose-600 text-white px-5 py-2.5 rounded-xl text-xs font-bold shadow-lg active:scale-95 transition-all"><i class="fas fa-chart-pie mr-2"></i> RAPORLAR</button>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-[32px] p-6 shadow-sm mb-6 no-print border border-gray-100">
            <div class="relative group">
                <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA GİRİN VEYA ARA" class="w-full px-6 py-5 bg-gray-50 border-2 border-transparent focus:border-rose-500 rounded-2xl font-black uppercase text-2xl mb-4 text-center outline-none transition-all placeholder:text-gray-300">
                <button onclick="startCamera()" class="absolute right-4 top-4 bg-rose-600 text-white w-12 h-12 rounded-xl shadow-lg active:scale-90 transition-all flex items-center justify-center">
                    <i class="fas fa-camera text-xl"></i>
                </button>
            </div>
            
            <div class="flex gap-3 mb-4">
                <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-rose-600 bg-rose-600 text-white transition-all shadow-md shadow-rose-100 uppercase tracking-widest">Otomobil</button>
                <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-gray-100 text-gray-400 bg-white transition-all uppercase tracking-widest">Minibüs</button>
            </div>
            <button onclick="aracGiris()" class="w-full bg-zinc-900 text-white py-5 rounded-2xl font-black text-sm shadow-xl active:scale-[0.98] transition-all uppercase tracking-widest">Girişi Kaydet</button>
        </div>

        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <div id="raporModal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-end sm:items-center justify-center no-print">
        <div class="bg-white w-full max-w-md rounded-t-[40px] sm:rounded-[40px] overflow-hidden max-h-[90vh] flex flex-col shadow-2xl">
            <div class="bg-zinc-900 p-8 text-white flex justify-between items-center">
                <div>
                    <h2 class="font-black text-2xl">Finansal Özet</h2>
                    <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Günlük Rapor</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="generatePDF()" class="bg-green-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-file-pdf text-xl"></i></button>
                    <button onclick="raporuKapat()" class="bg-zinc-800 w-12 h-12 rounded-2xl flex items-center justify-center active:scale-90"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 p-6 bg-gray-50">
                <div id="raporGorunumu">
                    <div id="ozetKartlari" class="grid grid-cols-3 gap-3 mb-6"></div>
                    <div class="bg-white rounded-3xl p-5 shadow-sm mb-4 border border-gray-100">
                        <h3 class="text-[10px] font-black text-gray-400 mb-4 uppercase tracking-widest">Son İşlemler</h3>
                        <div id="raporTablo" class="space-y-3 max-h-64 overflow-auto pr-2"></div>
                    </div>
                    <div id="netCiroBox" class="bg-zinc-900 rounded-3xl p-6 text-white flex justify-between items-center shadow-xl"></div>
                </div>
                
                <div id="tarifeGorunumu" class="hidden py-4">
                   <h3 class="font-black text-zinc-800 mb-4 text-center">Fiyat Tarifesini Düzenle</h3>
                   <div id="oto_fiyat_list" class="grid grid-cols-2 gap-2 mb-6"></div>
                   <div id="mini_fiyat_list" class="grid grid-cols-2 gap-2 mb-6"></div>
                   <button onclick="tarifeleriKaydet()" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg mb-4">Ayarları Kaydet</button>
                </div>

                <div class="mt-8 grid grid-cols-2 gap-3">
                    <button id="btnTarife" onclick="toggleView('tarife')" class="bg-white border-2 border-gray-100 py-4 rounded-2xl font-black text-[10px] uppercase text-zinc-600">Fiyat Düzenle</button>
                    <button onclick="raporuSifirla()" class="bg-rose-50 text-rose-600 border-2 border-rose-100 py-4 rounded-2xl font-black text-[10px] uppercase">Sistemi Sıfırla</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdfContainer" class="hidden">
        <div id="pdfTemplate">
            <div style="border-bottom: 5px solid #e11d48; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="font-size: 28px; font-weight: 900; margin: 0;">iSTAY PARK ÖZETİ</h1>
                <p id="pdfDate" style="margin: 5px 0; color: #444; font-weight: bold;"></p>
            </div>
            <table class="pdf-table">
                <thead><tr><th>PLAKA</th><th>TİP</th><th>GİRİŞ</th><th>ÇIKIŞ</th><th>ÖDEME</th><th>TUTAR</th></tr></thead>
                <tbody id="pdfBody"></tbody>
            </table>
            <div id="pdfSummaryArea" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;"></div>
        </div>
    </div>

    <script>
        // --- DEĞİŞKENLER VE AYARLAR ---
        let varsayilanTarife = {
            otomobil: [{min:0, max:1, ucret:170}, {min:1, max:2, ucret:210}, {min:2, max:4, ucret:290}, {min:4, max:6, ucret:360}, {min:6, max:8, ucret:420}, {min:8, max:12, ucret:500}, {min:12, max:24, ucret:600}],
            minibus: [{min:0, max:1, ucret:250}, {min:1, max:2, ucret:300}, {min:2, max:4, ucret:400}, {min:4, max:6, ucret:500}, {min:6, max:8, ucret:600}, {min:8, max:12, ucret:750}, {min:12, max:24, ucret:900}]
        };
        let aktifTarife = JSON.parse(localStorage.getItem('istay_tarifeler')) || varsayilanTarife;
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let seciliAracTipi = 'otomobil';
        let stream = null;

        // --- KAMERA VE PLAKA TANIMA MANTIĞI ---

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", focusMode: "continuous" } 
                });
                document.getElementById('videoFeed').srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'flex';
            } catch (err) {
                alert("Kameraya erişim reddedildi veya bulunamadı.");
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraContainer').style.display = 'none';
        }

        async function captureImage() {
            const video = document.getElementById('videoFeed');
            const canvas = document.createElement('canvas');
            const scale = video.videoWidth / video.offsetWidth;
            
            // Kırmızı kutunun koordinatlarını hesapla (Crop)
            const boxWidth = (video.offsetWidth * 0.85) * scale;
            const boxHeight = 120 * scale;
            const startX = (video.videoWidth - boxWidth) / 2;
            const startY = (video.videoHeight - boxHeight) / 2;

            canvas.width = boxWidth;
            canvas.height = boxHeight;
            const ctx = canvas.getContext('2d');

            // Görüntüyü keserek al
            ctx.drawImage(video, startX, startY, boxWidth, boxHeight, 0, 0, boxWidth, boxHeight);

            // --- GELİŞMİŞ SİYAH FİLTRESİ (Thresholding) ---
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const avg = (r + g + b) / 3;
                // Eşikleme: Yazılar siyah (0), geri kalan her şey beyaz (255) olsun
                const val = avg < 110 ? 0 : 255;
                data[i] = data[i+1] = data[i+2] = val;
            }
            ctx.putImageData(imageData, 0, 0);

            document.getElementById('scanStatus').innerText = "Filtreleniyor...";
            
            try {
                const result = await Tesseract.recognize(canvas, 'eng', {
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'
                });

                let plate = result.data.text.replace(/[^A-Z0-9]/g, "").trim();

                if (plate.length >= 5) {
                    openConfirmModal(plate);
                } else {
                    document.getElementById('scanStatus').innerText = "OKUNAMADI! YAKLAŞIN";
                    setTimeout(() => document.getElementById('scanStatus').innerText = "PLAKAYI KUTUYA ORTALAYIN", 2000);
                }
            } catch (e) {
                alert("OCR Hatası: " + e.message);
            }
        }

        function openConfirmModal(plaka) {
            document.getElementById('confirmedPlate').value = plaka;
            document.getElementById('confirmModal').classList.remove('hidden');
            stopCamera();
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function finalProcessPlate() {
            const plaka = document.getElementById('confirmedPlate').value.trim().toUpperCase();
            closeConfirmModal();
            if(!plaka) return;

            // Kontrol: Araç zaten içeride mi?
            const aktifArac = araclar.find(a => a.plaka === plaka && a.durum === 'aktif');
            
            if (aktifArac) {
                // ARAÇ İÇERİDE: ÇIKIŞ EKRANINI AÇ
                showScanExitModal(aktifArac);
            } else {
                // ARAÇ YENİ: GİRİŞ KUTUSUNA YAZ
                document.getElementById('plakaInput').value = plaka;
                renderList();
                // Küçük bir animasyonlu uyarı ver
                const toast = document.createElement('div');
                toast.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full text-xs font-bold z-[200] shadow-xl";
                toast.innerText = "YENİ ARAÇ GİRİŞE HAZIR: " + plaka;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        function showScanExitModal(arac) {
            const ucret = ucretHesapla(arac.giris, arac.tip);
            const sureStr = sureHesapla(arac.giris);
            
            document.getElementById('exitPlaka').innerText = arac.plaka;
            document.getElementById('exitGirisSaat').innerText = new Date(arac.giris).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('exitSure').innerText = sureStr;
            document.getElementById('exitTutar').innerHTML = `${ucret}<small class="text-xl">TL</small>`;
            
            // Buton Olayları
            document.getElementById('exitBtnHGS').onclick = () => { cikisYap(arac.id, 'HGS'); closeScanExitModal(); };
            document.getElementById('exitBtnKART').onclick = () => { cikisYap(arac.id, 'KART'); closeScanExitModal(); };
            document.getElementById('exitBtnNAKIT').onclick = () => { cikisYap(arac.id, 'NAKİT'); closeScanExitModal(); };
            
            document.getElementById('scanExitModal').classList.remove('hidden');
        }

        function closeScanExitModal() {
            document.getElementById('scanExitModal').classList.add('hidden');
        }

        // --- ANA FONKSİYONLAR ---

        function aracGiris() {
            const plakaInput = document.getElementById('plakaInput');
            const plaka = plakaInput.value.trim().toUpperCase();
            if (!plaka) return;

            // AYNI ARAÇTAN 2. KEZ EKLEME KONTROLÜ
            const icerideMi = araclar.find(a => a.plaka === plaka && a.durum === 'aktif');
            if (icerideMi) {
                alert("HATA: " + plaka + " plakalı araç zaten içeride! Çıkış yapmadan tekrar ekleyemezsiniz.");
                return;
            }

            araclar.push({
                id: Date.now(),
                plaka,
                tip: seciliAracTipi,
                giris: new Date().toISOString(),
                cikis: null,
                odemeYontemi: null,
                tutar: 0,
                durum: 'aktif'
            });
            
            localStorage.setItem('istay_park_data', JSON.stringify(araclar));
            plakaInput.value = "";
            renderList();
        }

        function cikisYap(id, yontem) {
            const index = araclar.findIndex(a => a.id === id);
            const a = araclar[index];
            a.tutar = ucretHesapla(a.giris, a.tip);
            a.cikis = new Date().toISOString();
            a.odemeYontemi = yontem;
            a.durum = 'tamamlandi';
            
            localStorage.setItem('istay_park_data', JSON.stringify(araclar));
            renderList();
        }

        function ucretHesapla(girisTarihi, tip) {
            const farkMs = new Date() - new Date(girisTarihi);
            if (farkMs / 60000 <= 4) return 0; // İlk 4 dk ücretsiz

            const toplamSaat = farkMs / 3600000;
            const tamGun = Math.floor(toplamSaat / 24);
            const kalanSaat = toplamSaat % 24;
            const t = aktifTarife[tip] || aktifTarife.otomobil;

            let ucret = tamGun * t[t.length - 1].ucret;
            if (kalanSaat > 0) {
                let ek = t[0].ucret;
                for (let k of t) {
                    if (kalanSaat > k.min && kalanSaat <= k.max) {
                        ek = k.ucret;
                        break;
                    }
                }
                ucret += ek;
            }
            return ucret;
        }

        function sureHesapla(g) {
            const f = new Date() - new Date(g);
            const s = Math.floor(f / 3600000);
            const d = Math.floor((f % 3600000) / 60000);
            return s + "sa " + d + "dk";
        }

        function renderList() {
            const filtre = document.getElementById('plakaInput').value.toUpperCase();
            const liste = document.getElementById('aracListesi');
            liste.innerHTML = '';

            let aktifler = araclar.filter(a => a.durum === 'aktif' && a.plaka.includes(filtre)).sort((a,b) => a.plaka.localeCompare(b.plaka));
            let bitenler = araclar.filter(a => a.durum === 'tamamlandi' && a.plaka.includes(filtre)).sort((a,b) => new Date(b.cikis) - new Date(a.cikis)).slice(0, 10);

            [...aktifler, ...bitenler].forEach(arac => {
                const isComp = arac.durum === 'tamamlandi';
                const ucret = isComp ? arac.tutar : ucretHesapla(arac.giris, arac.tip);
                
                const card = document.createElement('div');
                card.className = `p-6 rounded-[28px] shadow-sm relative border border-gray-100 ${isComp ? 'completed-card bg-white' : 'park-card bg-white'}`;
                card.innerHTML = `
                    <button onclick="sil(${arac.id})" class="absolute top-5 right-5 text-gray-200 hover:text-rose-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                    <div class="flex justify-between items-start pr-8">
                        <div>
                            <span class="text-[8px] font-black px-2 py-1 rounded-lg uppercase tracking-wider ${arac.tip==='minibus'?'bg-blue-50 text-blue-500':'bg-rose-50 text-rose-500'}">${arac.tip}</span>
                            <h3 class="text-2xl font-black text-zinc-800 mt-1">${arac.plaka}</h3>
                            <div class="text-[10px] font-bold text-gray-400 mt-1"><i class="fas fa-sign-in-alt mr-1"></i> Giriş: ${new Date(arac.giris).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black ${isComp ? 'text-zinc-400' : (ucret===0?'text-green-500':'text-rose-600')}">${ucret}<small class="text-xs ml-0.5">TL</small></div>
                            <div class="text-[9px] font-bold uppercase tracking-tighter">${isComp ? 'ÖDENDİ ('+arac.odemeYontemi+')' : sureHesapla(arac.giris)}</div>
                        </div>
                    </div>
                    ${!isComp ? `
                    <div class="grid grid-cols-3 gap-2 mt-5">
                        <button onclick="cikisYap(${arac.id}, 'HGS')" class="bg-blue-600 text-white py-3.5 rounded-2xl font-black text-[10px] uppercase shadow-md shadow-blue-100">HGS</button>
                        <button onclick="cikisYap(${arac.id}, 'KART')" class="bg-emerald-600 text-white py-3.5 rounded-2xl font-black text-[10px] uppercase shadow-md shadow-emerald-100">KART</button>
                        <button onclick="cikisYap(${arac.id}, 'NAKİT')" class="bg-amber-500 text-white py-3.5 rounded-2xl font-black text-[10px] uppercase shadow-md shadow-amber-100">NAKİT</button>
                    </div>` : ''}
                `;
                liste.appendChild(card);
            });
        }

        // --- RAPORLAMA VE DİĞER YARDIMCILAR ---

        function setAracTipi(t) {
            seciliAracTipi = t;
            const otoBtn = document.getElementById('type_oto');
            const miniBtn = document.getElementById('type_mini');
            if (t === 'otomobil') {
                otoBtn.className = 'flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-rose-600 bg-rose-600 text-white shadow-md shadow-rose-100 uppercase tracking-widest';
                miniBtn.className = 'flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-gray-100 text-gray-400 bg-white uppercase tracking-widest';
            } else {
                miniBtn.className = 'flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-blue-600 bg-blue-600 text-white shadow-md shadow-blue-100 uppercase tracking-widest';
                otoBtn.className = 'flex-1 py-4 rounded-2xl font-bold text-[10px] border-2 border-gray-100 text-gray-400 bg-white uppercase tracking-widest';
            }
        }

        function raporuGoster() {
            const bugun = new Date().toLocaleDateString('tr-TR');
            const bugunCikislar = araclar.filter(a => a.durum === 'tamamlandi' && new Date(a.cikis).toLocaleDateString('tr-TR') === bugun);
            
            let hgs = 0, kart = 0, nakit = 0, tabloHtml = "";
            bugunCikislar.forEach(a => {
                if(a.odemeYontemi === 'HGS') hgs += a.tutar;
                else if(a.odemeYontemi === 'KART') kart += a.tutar;
                else if(a.odemeYontemi === 'NAKİT') nakit += a.tutar;

                tabloHtml += `
                    <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-gray-100">
                        <div>
                            <div class="font-black text-xs text-zinc-800">${a.plaka}</div>
                            <div class="text-[8px] font-bold text-gray-400 uppercase">${a.tip}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-xs">${a.tutar} TL</div>
                            <div class="text-[8px] font-bold text-rose-500 uppercase">${a.odemeYontemi}</div>
                        </div>
                    </div>`;
            });

            document.getElementById('ozetKartlari').innerHTML = `
                <div class="bg-blue-600 p-4 rounded-3xl text-white shadow-lg shadow-blue-100"><div class="text-[8px] font-bold opacity-70 uppercase mb-1">HGS</div><div class="text-xl font-black">${hgs}</div></div>
                <div class="bg-emerald-600 p-4 rounded-3xl text-white shadow-lg shadow-emerald-100"><div class="text-[8px] font-bold opacity-70 uppercase mb-1">Kart</div><div class="text-xl font-black">${kart}</div></div>
                <div class="bg-amber-500 p-4 rounded-3xl text-white shadow-lg shadow-amber-100"><div class="text-[8px] font-bold opacity-70 uppercase mb-1">Nakit</div><div class="text-xl font-black">${nakit}</div></div>`;
            
            document.getElementById('raporTablo').innerHTML = tabloHtml || `<p class="text-center text-zinc-300 py-10 font-bold text-xs uppercase tracking-widest">Kayıt Bulunmuyor</p>`;
            document.getElementById('netCiroBox').innerHTML = `<div><h4 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Günlük Toplam</h4><p class="text-3xl font-black">${hgs+kart+nakit} TL</p></div><i class="fas fa-wallet text-4xl opacity-10"></i>`;
            
            document.getElementById('raporModal').classList.remove('hidden');
        }

        function raporuKapat() {
            document.getElementById('raporModal').classList.add('hidden');
            toggleView('rapor');
        }

        function toggleView(v) {
            const r = document.getElementById('raporGorunumu');
            const t = document.getElementById('tarifeGorunumu');
            const b = document.getElementById('btnTarife');
            if (v === 'tarife') {
                r.classList.add('hidden'); t.classList.remove('hidden');
                b.innerText = "Rapora Dön"; b.onclick = () => toggleView('rapor');
                tarifeListele();
            } else {
                t.classList.add('hidden'); r.classList.remove('hidden');
                b.innerText = "Fiyat Düzenle"; b.onclick = () => toggleView('tarife');
            }
        }

        function sil(id) {
            if(confirm('Kayıt silinecek. Onaylıyor musunuz?')) {
                araclar = araclar.filter(a => a.id !== id);
                localStorage.setItem('istay_park_data', JSON.stringify(araclar));
                renderList();
            }
        }

        function raporuSifirla() {
            if(confirm("TÜM VERİLER SIFIRLANACAK! Emin misiniz?")) {
                araclar = [];
                localStorage.setItem('istay_park_data', "[]");
                renderList();
                raporuKapat();
            }
        }

        // Başlangıç
        renderList();
        setInterval(renderList, 60000); // Dakikada bir süreleri güncelle
    </script>
</body>
</html>
