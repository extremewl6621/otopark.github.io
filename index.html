<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK - TR PLAKA AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { background: #000; font-family: sans-serif; overflow: hidden; }
        #cameraOverlay { position: fixed; inset: 0; z-index: 100; display: none; background: #000; }
        #v { width: 100%; height: 100%; object-fit: cover; }
        
        /* Odak Çerçevesi */
        .tr-plate-focus { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 120px; border: 3px solid #3b82f6; border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); z-index: 110;
        }
        .tr-plate-focus::before {
            content: "TR"; position: absolute; left: 0; top: 0; bottom: 0; width: 30px;
            background: #003399; color: white; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; font-size: 12px;
        }
        .line { position: absolute; width: 100%; height: 2px; background: #3b82f6; top: 50%; animation: scan 2s infinite; }
        @keyframes scan { 0%, 100% { top: 10%; } 50% { top: 90%; } }
    </style>
</head>
<body>

    <div class="h-screen flex flex-col p-4 bg-zinc-900 overflow-y-auto">
        <div class="mb-6 bg-zinc-800 p-6 rounded-3xl shadow-2xl">
            <div class="relative mb-4">
                <input type="text" id="pInp" oninput="draw()" placeholder="PLAKA" class="w-full py-5 px-4 bg-zinc-900 border-2 border-zinc-700 rounded-2xl font-black text-4xl text-center text-white uppercase outline-none focus:border-blue-500">
                <button onclick="startC()" class="absolute right-3 top-3 bottom-3 w-14 bg-blue-600 rounded-xl text-white shadow-lg active:scale-90">
                    <i class="fas fa-camera-viewfinder text-xl"></i>
                </button>
            </div>
            
            <div id="actionBtn" class="hidden">
                <div class="flex gap-2 mb-4">
                    <button id="tO" onclick="setT('otomobil')" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600">OTOMOBİL</button>
                    <button id="tM" onclick="setT('minibus')" class="flex-1 py-3 rounded-xl font-bold text-zinc-400 border-2 border-zinc-700">MİNİBÜS</button>
                </div>
                <button onclick="save()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-xl active:scale-95">GİRİŞİ KAYDET</button>
            </div>
        </div>
        <div id="list" class="space-y-4"></div>
    </div>

    <div id="cameraOverlay">
        <video id="v" autoplay playsinline></video>
        <div class="tr-plate-focus"><div class="line"></div></div>
        <div class="absolute bottom-10 inset-x-0 flex flex-col items-center gap-6 z-[120]">
            <p id="status" class="text-white text-xs font-bold bg-black/50 px-4 py-2 rounded-full uppercase tracking-tighter">Plakayı Mavi Çerçeveye Alın</p>
            <div class="flex gap-16 items-center">
                <button onclick="stopC()" class="text-white/50 font-bold uppercase text-sm">İptal</button>
                <button onclick="snap()" class="w-20 h-20 bg-blue-600 rounded-full border-4 border-white flex items-center justify-center shadow-2xl">
                    <i class="fas fa-camera text-3xl text-white"></i>
                </button>
                <div class="w-10"></div>
            </div>
        </div>
        <canvas id="c" style="display:none;"></canvas>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('istay_v8')) || [];
        let type = 'otomobil';
        let stream = null;

        async function startC() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280 } });
                document.getElementById('v').srcObject = stream;
                document.getElementById('cameraOverlay').style.display = 'block';
            } catch (e) { alert("Kamera izni gerekli."); }
        }

        function stopC() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraOverlay').style.display = 'none';
        }

        async function snap() {
            const video = document.getElementById('v');
            const canvas = document.getElementById('c');
            const ctx = canvas.getContext('2d');
            
            // Hassas Kesme: Sadece orta alanı yüksek çözünürlükte işle
            const scale = video.videoWidth / video.clientWidth;
            const w = 85 * (video.clientWidth / 100) * scale;
            const h = 120 * scale;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = w; canvas.height = h;
            ctx.filter = 'contrast(1.4) grayscale(1)'; // Plaka okuma başarısını artırmak için filtre
            ctx.drawImage(video, x, y, w, h, 0, 0, w, h);
            
            document.getElementById('status').innerText = "TR PLAKA ANALİZ EDİLİYOR...";
            runOCR(canvas.toDataURL('image/jpeg', 1.0));
        }

        async function runOCR(src) {
            try {
                const worker = await Tesseract.createWorker('eng');
                const { data: { text } } = await worker.recognize(src);
                await worker.terminate();

                // TÜRKİYE PLAKA FİLTRESİ (Regex)
                // Kalıp: 2 rakam + 1-3 harf + 2-4 rakam
                const matches = text.toUpperCase().replace(/[^A-Z0-9]/g, "").match(/([0-8][0-9][A-Z]{1,3}[0-9]{2,4})/);
                
                if(matches && matches[0]) {
                    document.getElementById('pInp').value = matches[0];
                    stopC();
                    draw();
                } else {
                    alert("Türkiye plaka formatı bulunamadı.\nLütfen çerçeveyi plakaya yaklaştırın.");
                    document.getElementById('status').innerText = "YENİDEN DENEYİN";
                }
            } catch (e) { alert("AI Hatası"); }
        }

        function draw() {
            const val = document.getElementById('pInp').value.toUpperCase();
            const listCont = document.getElementById('list');
            const actionBtn = document.getElementById('actionBtn');
            listCont.innerHTML = '';

            const isA = db.find(a => a.p === val && a.d === 'aktif');
            actionBtn.className = isA ? 'hidden' : 'block';

            db.filter(a => a.p.includes(val)).sort((a,b) => (a.d === 'aktif' ? -1 : 1)).forEach(a => {
                const isActive = a.d === 'aktif';
                const div = document.createElement('div');
                div.className = `p-6 rounded-3xl ${isActive ? 'bg-white' : 'bg-zinc-800 opacity-50'} relative shadow-lg`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-bold text-blue-600 uppercase">${a.t}</span>
                            <h2 class="text-3xl font-black ${isActive?'text-zinc-900':'text-zinc-400'}">${a.p}</h2>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-black text-rose-600">${isActive ? '170' : a.price} TL</span>
                        </div>
                    </div>
                    ${isActive ? `
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="out(${a.id},'HGS')" class="bg-blue-600 text-white py-4 rounded-xl font-bold text-xs">HGS</button>
                        <button onclick="out(${a.id},'KART')" class="bg-zinc-900 text-white py-4 rounded-xl font-bold text-xs">KART</button>
                        <button onclick="out(${a.id},'NAKİT')" class="bg-amber-500 text-white py-4 rounded-xl font-bold text-xs">NAKİT</button>
                    </div>` : ''}
                `;
                listCont.appendChild(div);
            });
        }

        function save() {
            const p = document.getElementById('pInp').value.trim().toUpperCase();
            if(!p) return;
            db.push({ id: Date.now(), p, t: type, g: new Date().toISOString(), d: 'aktif' });
            localStorage.setItem('istay_v8', JSON.stringify(db));
            document.getElementById('pInp').value = "";
            draw();
        }

        function out(id, pay) {
            const a = db.find(x => x.id === id);
            a.price = '170'; a.pay = pay; a.d = 'done';
            localStorage.setItem('istay_v8', JSON.stringify(db));
            document.getElementById('pInp').value = "";
            draw();
        }

        function setT(v) { 
            type = v; 
            document.getElementById('tO').className = v === 'otomobil' ? 'flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600' : 'flex-1 py-3 rounded-xl font-bold text-zinc-400 border-2 border-zinc-700';
            document.getElementById('tM').className = v === 'minibus' ? 'flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white border-2 border-blue-600' : 'flex-1 py-3 rounded-xl font-bold text-zinc-400 border-2 border-zinc-700';
        }

        draw();
    </script>
</body>
</html>
