<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tesseract.js ve Camerayı ekliyoruz -->
    <script src="https://unpkg.com/tesseract.js@v4.0.0/dist/tesseract.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; transition: all 0.3s; position: relative; background: white; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.8; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        
        /* PDF Gelişmiş Tasarım */
        #pdfTemplate { width: 100%; background: white; padding: 20px; color: black; display: none; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { background: #1a1a1a; color: white; border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
        .pdf-table td { border: 1px solid #ddd; padding: 8px; font-size: 11px; }
        
        /* Kamera Modalı */
        #cameraModal { background: rgba(0,0,0,0.95); }
        #cameraPreview { width: 100%; max-width: 400px; border-radius: 12px; overflow: hidden; background: #000; }
        #plakaSonuc { font-family: monospace; letter-spacing: 2px; }
        .plaka-hint { font-size: 10px; color: #999; margin-top: 4px; }
        
        /* Çıkış için Plaka Seçim Modalı */
        #plakaSecimModal .arac-item { transition: all 0.2s; cursor: pointer; }
        #plakaSecimModal .arac-item:hover { background-color: #f3f4f6; transform: scale(1.02); }
    </style>
</head>
<body class="pb-20">

    <!-- HEADER - Kamera butonu eklendi -->
    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <div class="flex gap-2">
            <button onclick="kamerayiAc('giris')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95"><i class="fas fa-camera mr-1"></i> PLAKA TARA</button>
            <button onclick="raporuGoster()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95"><i class="fas fa-chart-pie mr-1"></i> RAPORLAR</button>
        </div>
    </div>

    <!-- PDF Bölümü (Değişmedi) -->
    <div id="pdfContainer">
        <div id="pdfTemplate">
            <div style="border-bottom: 5px solid #e11d48; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="font-size: 28px; font-weight: 900; margin: 0;">iSTAY PARK ÖZETİ</h1>
                <p id="pdfDate" style="margin: 5px 0; color: #444; font-weight: bold;"></p>
            </div>
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th>PLAKA</th><th>ARAÇ TİPİ</th><th>GİRİŞ SAATİ</th><th>ÇIKIŞ SAATİ</th><th>ÖDEME</th><th>TUTAR</th>
                    </tr>
                </thead>
                <tbody id="pdfBody"></tbody>
            </table>
            <div id="pdfSummaryArea" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;"></div>
        </div>
    </div>

    <!-- Ana İçerik (Değişmedi) -->
    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-6 no-print">
            <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA GİRİN VEYA ARA" class="w-full px-4 py-4 border-2 border-gray-100 rounded-2xl font-black uppercase text-2xl mb-4 text-center focus:border-rose-500 outline-none transition-all">
            <div class="flex gap-3 mb-4">
                <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white transition">OTOMOBİL</button>
                <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-gray-100 text-gray-500 transition">MİNİBÜS</button>
            </div>
            <button onclick="aracGiris()" class="w-full bg-zinc-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">GİRİŞİ KAYDET</button>
        </div>
        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <!-- KAMERA MODALI -->
    <div id="cameraModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
            <div class="bg-white rounded-3xl overflow-hidden shadow-2xl">
                <div class="bg-zinc-900 p-6 text-white flex justify-between items-center">
                    <h2 class="font-black text-xl" id="cameraModalTitle">PLAKA TANIMA</h2>
                    <button onclick="kamerayiKapat()" class="bg-zinc-800 w-12 h-12 rounded-2xl flex items-center justify-center active:scale-90"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-6">
                    <div class="mb-4 text-center">
                        <div class="text-sm font-bold text-gray-600 mb-2">Kamerayı plakaya doğrultun</div>
                        <div class="text-xs text-gray-500">Plakanın net ve ışıklı olmasına dikkat edin</div>
                    </div>
                    
                    <div class="relative">
                        <video id="cameraVideo" autoplay playsinline class="w-full h-64 object-cover rounded-2xl bg-black"></video>
                        <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                            <div class="border-2 border-green-500 w-64 h-32 rounded-lg"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <div class="text-lg font-black text-zinc-800 mb-2" id="plakaSonuc">---</div>
                        <div class="text-sm text-gray-600 plaka-hint" id="plakaOneri"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="fotografCek()" class="bg-rose-600 text-white py-4 rounded-2xl font-black text-lg"><i class="fas fa-camera mr-2"></i> TARA</button>
                        <button onclick="kamerayiKapat()" class="bg-gray-200 text-gray-800 py-4 rounded-2xl font-black text-lg">VAZGEÇ</button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="otomatikGiris" checked class="mr-2">
                            <span class="text-sm font-bold">Tanıma sonrası otomatik giriş yap</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÇIKIŞ İÇİN PLAKA SEÇİM MODALI -->
    <div id="plakaSecimModal" class="hidden fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-zinc-900 p-6 text-white flex justify-between items-center">
                <h2 class="font-black text-xl">PLAKA SEÇİN</h2>
                <button onclick="plakaSecimModalKapat()" class="bg-zinc-800 w-12 h-12 rounded-2xl flex items-center justify-center active:scale-90"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="mb-4">
                    <input type="text" id="plakaAramaInput" oninput="plakaAra()" placeholder="Plaka ara..." class="w-full px-4 py-3 border-2 border-gray-100 rounded-2xl font-bold text-lg uppercase text-center focus:border-rose-500 outline-none">
                </div>
                
                <div id="plakaListesi" class="space-y-2">
                    <!-- Aktif araçlar buraya eklenecek -->
                </div>
                
                <div id="plakaBulunamadi" class="hidden text-center py-8">
                    <i class="fas fa-car text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 font-bold">Aktif aracınız bulunamadı</p>
                    <p class="text-gray-400 text-sm mt-2">Önce araç girişi yapmalısınız</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ÖDEME YÖNTEMİ SEÇİM MODALI -->
    <div id="odemeModal" class="hidden fixed inset-0 bg-black/90 z-[95] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl overflow-hidden">
            <div class="bg-zinc-900 p-6 text-white text-center">
                <h2 class="font-black text-xl" id="odemePlaka">34 ABC 123</h2>
                <p class="text-sm opacity-80 mt-1">Ödeme yöntemini seçin</p>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 gap-3 mb-6">
                    <button onclick="cikisYapSecili('HGS')" class="bg-blue-600 text-white py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3">
                        <i class="fas fa-satellite-dish"></i> HGS
                    </button>
                    <button onclick="cikisYapSecili('KART')" class="bg-emerald-600 text-white py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3">
                        <i class="fas fa-credit-card"></i> KART
                    </button>
                    <button onclick="cikisYapSecili('NAKİT')" class="bg-amber-500 text-white py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3">
                        <i class="fas fa-money-bill-wave"></i> NAKİT
                    </button>
                </div>
                
                <button onclick="odemeModalKapat()" class="w-full bg-gray-200 text-gray-800 py-4 rounded-2xl font-black">VAZGEÇ</button>
            </div>
        </div>
    </div>

    <!-- ORJİNAL MODALLAR (Değişmedi) -->
    <div id="raporModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-end sm:items-center justify-center no-print">
        <!-- Orjinal rapor modal içeriği aynı -->
        <!-- Kodu kısaltmak için içeriği kopyalamadım -->
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <!-- Orjinal edit modal içeriği aynı -->
    </div>

    <script>
        // ORJİNAL DEĞİŞKENLER VE FONKSİYONLAR
        let varsayilanTarife = {
            otomobil: [ { min: 0, max: 1, ucret: 170 }, { min: 1, max: 2, ucret: 210 }, { min: 2, max: 4, ucret: 290 }, { min: 4, max: 6, ucret: 360 }, { min: 6, max: 8, ucret: 420 }, { min: 8, max: 12, ucret: 500 }, { min: 12, max: 24, ucret: 600 } ],
            minibus: [ { min: 0, max: 1, ucret: 250 }, { min: 1, max: 2, ucret: 300 }, { min: 2, max: 4, ucret: 400 }, { min: 4, max: 6, ucret: 500 }, { min: 6, max: 8, ucret: 600 }, { min: 8, max: 12, ucret: 750 }, { min: 12, max: 24, ucret: 900 } ]
        };
        let aktifTarife = JSON.parse(localStorage.getItem('istay_tarifeler')) || varsayilanTarife;
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let seciliAracTipi = 'otomobil';
        
        // KAMERA DEĞİŞKENLERİ
        let cameraStream = null;
        let cameraModalMode = 'giris'; // 'giris' veya 'cikis'
        let seciliCikisAraci = null;
        
        // KAMERA FONKSİYONLARI
        async function kamerayiAc(mode) {
            cameraModalMode = mode;
            document.getElementById('cameraModal').classList.remove('hidden');
            document.getElementById('cameraModalTitle').textContent = 
                mode === 'giris' ? 'PLAKA TANIMA (GİRİŞ)' : 'PLAKA TANIMA (ÇIKIŞ)';
            document.getElementById('plakaSonuc').textContent = '---';
            document.getElementById('plakaOneri').textContent = '';
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
            } catch (err) {
                console.error("Kamera hatası:", err);
                alert("Kamera erişimi sağlanamadı. Lütfen izin verin.");
                kamerayiKapat();
            }
        }
        
        function kamerayiKapat() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }
        
        async function fotografCek() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Plaka bölgesini kırp (yakınlaştırma efekti)
            const cropX = video.videoWidth * 0.2;
            const cropY = video.videoHeight * 0.3;
            const cropWidth = video.videoWidth * 0.6;
            const cropHeight = video.videoHeight * 0.25;
            
            ctx.drawImage(video, cropX, cropY, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);
            
            document.getElementById('plakaSonuc').textContent = "Tanımlanıyor...";
            
            try {
                // Tesseract OCR ile plaka tanıma
                const worker = await Tesseract.createWorker('tur');
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPRSTUVYZ0123456789 ',
                    preserve_interword_spaces: '1'
                });
                
                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();
                
                // Plakayı temizle ve formatla
                let plaka = text.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // Türkiye plaka formatına uygun hale getir
                if (plaka.length >= 3) {
                    // Rakamları ve harfleri ayır
                    let harfler = plaka.replace(/[0-9]/g, '');
                    let rakamlar = plaka.replace(/[A-Z]/g, '');
                    
                    // Format: 34ABC123 gibi
                    if (harfler.length >= 2 && rakamlar.length >= 2) {
                        plaka = rakamlar.substring(0, 2) + harfler.substring(0, 3) + rakamlar.substring(2, 5);
                        plaka = plaka.substring(0, 8); // Maksimum 8 karakter
                    }
                }
                
                document.getElementById('plakaSonuc').textContent = plaka || "Tanınamadı";
                
                if (plaka && plaka.length >= 5) {
                    // Plaka önerisi göster
                    const oneri = plakaFormatla(plaka);
                    document.getElementById('plakaOneri').textContent = `Öneri: ${oneri}`;
                    
                    // Otomatik giriş yapılacak mı?
                    const otomatikGiris = document.getElementById('otomatikGiris').checked;
                    
                    if (cameraModalMode === 'giris') {
                        if (otomatikGiris) {
                            // Aynı plaka aktifte var mı kontrol et
                            const aktifArac = araclar.find(a => 
                                a.durum === 'aktif' && 
                                a.plaka.replace(/\s/g, '') === plaka.replace(/\s/g, '')
                            );
                            
                            if (aktifArac) {
                                alert("Bu plakaya ait araç zaten park halinde!");
                            } else {
                                document.getElementById('plakaInput').value = oneri;
                                setTimeout(() => {
                                    aracGiris();
                                    kamerayiKapat();
                                }, 500);
                            }
                        } else {
                            document.getElementById('plakaInput').value = oneri;
                            setTimeout(() => {
                                kamerayiKapat();
                            }, 500);
                        }
                    } else if (cameraModalMode === 'cikis') {
                        // Çıkış için plaka arama
                        const aktifArac = araclar.find(a => 
                            a.durum === 'aktif' && 
                            a.plaka.replace(/\s/g, '') === plaka.replace(/\s/g, '')
                        );
                        
                        if (aktifArac) {
                            odemeModalAc(aktifArac);
                            kamerayiKapat();
                        } else {
                            alert("Bu plakaya ait aktif araç bulunamadı!");
                        }
                    }
                }
                
            } catch (error) {
                console.error("OCR hatası:", error);
                document.getElementById('plakaSonuc').textContent = "Hata! Tekrar deneyin";
            }
        }
        
        function plakaFormatla(plaka) {
            // Türkiye plaka formatı: 34 ABC 123 veya 34 ABC 12
            let temiz = plaka.replace(/\s/g, '');
            if (temiz.length >= 2) {
                let bol1 = temiz.substring(0, 2);
                let bol2 = temiz.substring(2, 5);
                let bol3 = temiz.substring(5, 8);
                return `${bol1} ${bol2} ${bol3}`.trim();
            }
            return plaka;
        }
        
        // ÇIKIŞ İÇİN PLAKA SEÇİM FONKSİYONLARI
        function cikisIcinPlakaSec() {
            kamerayiAc('cikis');
        }
        
        function plakaSecimModalAc() {
            const aktifAraclar = araclar.filter(a => a.durum === 'aktif');
            
            if (aktifAraclar.length === 0) {
                document.getElementById('plakaBulunamadi').classList.remove('hidden');
                document.getElementById('plakaListesi').innerHTML = '';
            } else {
                document.getElementById('plakaBulunamadi').classList.add('hidden');
                let html = '';
                aktifAraclar.forEach(arac => {
                    html += `
                        <div class="arac-item bg-white p-4 rounded-2xl border-2 border-gray-100" onclick="odemeModalAc(${arac.id})">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-xl font-black">${arac.plaka}</div>
                                    <div class="text-xs text-gray-500">${arac.tip} • ${sureHesapla(arac.giris)}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black text-rose-600">${ucretHesapla(arac.giris, arac.tip)}<small class="text-xs">TL</small></div>
                                    <div class="text-[10px] font-bold text-gray-400">ÇIKIŞ</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('plakaListesi').innerHTML = html;
            }
            
            document.getElementById('plakaSecimModal').classList.remove('hidden');
        }
        
        function plakaSecimModalKapat() {
            document.getElementById('plakaSecimModal').classList.add('hidden');
        }
        
        function plakaAra() {
            const arama = document.getElementById('plakaAramaInput').value.toUpperCase();
            const items = document.querySelectorAll('#plakaListesi .arac-item');
            
            items.forEach(item => {
                const plaka = item.querySelector('.text-xl').textContent;
                if (plaka.includes(arama)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // ÖDEME MODAL FONKSİYONLARI
        function odemeModalAc(aracId) {
            const arac = typeof aracId === 'object' ? aracId : araclar.find(a => a.id === aracId);
            seciliCikisAraci = arac;
            
            document.getElementById('odemePlaka').textContent = arac.plaka;
            document.getElementById('odemeModal').classList.remove('hidden');
            plakaSecimModalKapat();
        }
        
        function odemeModalKapat() {
            document.getElementById('odemeModal').classList.add('hidden');
            seciliCikisAraci = null;
        }
        
        function cikisYapSecili(yontem) {
            if (seciliCikisAraci) {
                cikisYap(seciliCikisAraci.id, yontem);
                odemeModalKapat();
                // Başarı mesajı
                setTimeout(() => {
                    alert(`${seciliCikisAraci.plaka} plakalı araç ${yontem} ile çıkış yaptı!`);
                }, 300);
            }
        }
        
        // HEADER'A ÇIKIŞ BUTONU EKLEME
        document.addEventListener('DOMContentLoaded', function() {
            // Header'a çıkış butonu ekle
            const headerButtons = document.querySelector('.header-banner .flex');
            if (headerButtons && !document.getElementById('cikisButonu')) {
                const cikisBtn = document.createElement('button');
                cikisBtn.id = 'cikisButonu';
                cikisBtn.onclick = plakaSecimModalAc;
                cikisBtn.className = 'bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95';
                cikisBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i> ÇIKIŞ';
                headerButtons.insertBefore(cikisBtn, headerButtons.firstChild);
            }
        });
        
        // ORJİNAL FONKSİYONLAR (Değişmeden)
        function ucretHesapla(girisTarihi, tip) {
            const farkMs = new Date() - new Date(girisTarihi);
            if (farkMs / 60000 <= 4) return 0;
            const toplamSaat = farkMs / 3600000;
            const tamGun = Math.floor(toplamSaat / 24);
            const kalanSaat = toplamSaat % 24;
            const t = aktifTarife[tip] || aktifTarife.otomobil;
            let u = tamGun * t[t.length - 1].ucret;
            if (kalanSaat > 0) {
                let ek = t[0].ucret; 
                for (let k of t) { if (kalanSaat > k.min && kalanSaat <= k.max) { ek = k.ucret; break; } }
                u += ek;
            }
            return u;
        }
        
        function renderList() {
            const filtre = document.getElementById('plakaInput').value.toUpperCase();
            const liste = document.getElementById('aracListesi');
            liste.innerHTML = '';

            let aktifler = araclar.filter(a => a.durum === 'aktif' && a.plaka.includes(filtre)).sort((a, b) => a.plaka.localeCompare(b.plaka));
            let tamamlananlar = araclar.filter(a => a.durum === 'tamamlandi' && a.plaka.includes(filtre)).sort((a, b) => new Date(b.cikis) - new Date(a.cikis));

            [...aktifler, ...tamamlananlar].forEach(arac => {
                const isComp = arac.durum === 'tamamlandi';
                const ucret = isComp ? arac.tutar : ucretHesapla(arac.giris, arac.tip);
                const isFree = ((isComp ? new Date(arac.cikis) : new Date()) - new Date(arac.giris)) / 60000 <= 4;

                const card = document.createElement('div');
                card.className = `p-5 rounded-3xl shadow-sm relative ${isComp ? 'completed-card bg-white' : 'park-card bg-white'}`;
                const silBtn = `<button onclick="sil(${arac.id})" class="absolute top-4 right-4 text-gray-300 hover:text-rose-500 p-2 z-10"><i class="fas fa-trash"></i></button>`;

                card.innerHTML = `
                    ${silBtn}
                    <div class="flex justify-between items-start pr-10">
                        <div>
                            <span class="text-[8px] font-black px-2 py-1 rounded-lg uppercase ${arac.tip==='minibus'?'bg-blue-100 text-blue-600':'bg-rose-100 text-rose-600'}">${arac.tip}</span>
                            <h3 class="text-2xl font-black text-zinc-800 mt-1">${arac.plaka}</h3>
                            <div onclick="openEditModal(${arac.id})" class="text-[10px] font-bold text-gray-400 mt-1 cursor-pointer">
                                <i class="fas fa-clock mr-1"></i> Giriş: ${new Date(arac.giris).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <span class="underline">Düzelt</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black ${isComp ? 'text-gray-400' : (ucret===0?'text-green-500':'text-rose-600')}">${ucret}<small class="text-xs ml-0.5">TL</small></div>
                            <div class="text-[10px] font-bold ${isFree && !isComp ? 'text-green-500':'text-gray-400'} uppercase">
                                ${isComp ? 'ÖDENDİ ('+arac.odemeYontemi+')' : (isFree ? 'ÜCRETSİZ' : sureHesapla(arac.giris))}
                            </div>
                        </div>
                    </div>
                    ${!isComp ? `
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="cikisYap(${arac.id}, 'HGS')" class="bg-blue-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">HGS</button>
                        <button onclick="cikisYap(${arac.id}, 'KART')" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">KART</button>
                        <button onclick="cikisYap(${arac.id}, 'NAKİT')" class="bg-amber-500 text-white py-3 rounded-xl font-black text-[10px] uppercase">NAKİT</button>
                    </div>` : ''}
                `;
                liste.appendChild(card);
            });
        }
        
        // Diğer orjinal fonksiyonlar aynen kalıyor...
        function generatePDF() { /* Aynı */ }
        function toggleView(view) { /* Aynı */ }
        function renderTarifeInputs() { /* Aynı */ }
        function tarifeleriKaydet() { /* Aynı */ }
        function veriyiIceriAktar(e) { /* Aynı */ }
        function raporuGoster() { /* Aynı */ }
        function aracGiris() { /* Aynı */ }
        function cikisYap(id, yontem) { /* Aynı */ }
        function sureHesapla(g) { /* Aynı */ }
        function setAracTipi(t) { /* Aynı */ }
        function openEditModal(id) { /* Aynı */ }
        function closeEditModal() { /* Aynı */ }
        function raporuKapat() { /* Aynı */ }
        function sil(id) { /* Aynı */ }
        function raporuSifirla() { /* Aynı */ }
        function veriyiDisaAktar() { /* Aynı */ }
        
        // UYGULAMA BAŞLANGICI
        renderList();
        setInterval(renderList, 30000);
        
        // Sayfa kapanırken kamerayı kapat
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>