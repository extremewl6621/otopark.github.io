<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personel Takip V29 - Otomatik Form Sıfırlama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #f0f2f5; --card-radius: 12px; --input-radius: 8px; }
        body { background-color: var(--primary-bg); font-family: 'Inter', sans-serif; font-size: 0.85rem; color: #34495e; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        #mainContent { display: none; }
        .navbar-custom { background: linear-gradient(to right, #2c3e50, #4ca1af); padding: 10px 0; }
        .card { border: none; border-radius: var(--card-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.03); background: #fff; margin-bottom: 15px; }
        .card-header { background: #fff; border-bottom: 1px solid #f1f1f1; padding: 12px 15px; font-weight: 700; display: flex; align-items: center; border-radius: var(--card-radius) var(--card-radius) 0 0 !important; }
        .header-icon { margin-right: 8px; color: #3498db; background: #eaf6ff; padding: 6px; border-radius: 6px; }
        .form-control, .form-select { border-radius: var(--input-radius); border: 1px solid #dee2e6; padding: 8px 10px; font-size: 0.85rem; }
        .table-custom td { vertical-align: middle; padding: 12px 8px; }
        .shift-info-row { display: block; border-bottom: 1px dashed #eee; padding: 2px 0; font-size: 0.8rem; }
        .total-display { font-size: 1.4rem; font-weight: 800; color: #27ae60; }
        .pointer { cursor: pointer; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <i class="fa-solid fa-user-shield fa-3x mb-3 text-primary"></i>
        <h4 class="fw-bold mb-4">Sistem Girişi</h4>
        <input type="text" id="userInput" class="form-control mb-3" placeholder="Kullanıcı Adı">
        <input type="password" id="passInput" class="form-control mb-4" placeholder="Şifre">
        <button onclick="validateLogin()" class="btn btn-primary w-100 fw-bold py-2">GİRİŞ YAP</button>
        <p id="loginError" class="text-danger small mt-3" style="display:none;">Hatalı kullanıcı adı veya şifre!</p>
    </div>
</div>

<div id="mainContent">
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#"><i class="fa-solid fa-lock me-2"></i>Personel Takip V29</a>
            <div class="ms-auto d-flex gap-2">
                <a href="otopark.html" class="btn btn-light btn-sm text-dark fw-bold px-3"><i class="fa-solid fa-square-parking me-1 text-primary"></i> Otopark</a>
                <button onclick="downloadBackup()" class="btn btn-light btn-sm text-dark fw-bold px-3"><i class="fa-solid fa-download me-1 text-primary"></i> İndir</button>
                <label class="btn btn-light btn-sm text-dark fw-bold mb-0 px-3 pointer"><i class="fa-solid fa-upload me-1 text-primary"></i> Yükle<input type="file" hidden onchange="uploadBackup(this)"></label>
                <button onclick="clearCurrentList()" class="btn btn-danger btn-sm ms-2" title="Listeyi Temizle"><i class="fa-solid fa-trash-can"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-3 py-3">
        <div class="row g-3">
            <div class="col-lg-4 col-xl-3">
                <div class="card shadow-sm">
                    <div class="card-header"><i class="fa-solid fa-warehouse header-icon"></i> Otopark Ekle</div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" id="newLocationName" class="form-control" style="text-transform: uppercase;" placeholder="OTOPARK ADI">
                            <button onclick="addNewLocation()" class="btn btn-dark btn-sm fw-bold">Ekle</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header"><i class="fa-solid fa-user-plus header-icon"></i> Personel Ekle</div>
                    <div class="card-body">
                        <input type="text" id="dbName" class="form-control mb-2" maxlength="30" style="text-transform: uppercase;" placeholder="AD SOYAD (MAX 30)">
                        <div class="row g-2 mb-2">
                            <div class="col-6"><input type="text" id="dbPhone" class="form-control" placeholder="(5XX) XXX XX XX" maxlength="15"></div>
                            <div class="col-6"><input type="text" id="dbIban" class="form-control" style="text-transform: uppercase;" placeholder="IBAN (26 Karakter)" maxlength="26"></div>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text fw-bold">₺</span>
                            <input type="number" id="dbRate" class="form-control" value="165">
                            <button onclick="addNewPersonnel()" class="btn btn-dark btn-sm fw-bold">Ekle</button>
                        </div>
                    </div>
                </div>

                <div class="card border-top border-4 border-success shadow-sm">
                    <div class="card-header bg-white"><i class="fa-solid fa-file-pen header-icon" style="color:#27ae60;"></i> <span class="fw-bold">Mesai Girişi</span></div>
                    <div class="card-body">
                        <label class="small fw-bold text-muted mb-1">PERSONEL SEÇ</label>
                        <div class="input-group mb-2">
                            <select id="personSelect" class="form-select fw-bold" onchange="fillPersonDetails()"></select>
                            <button class="btn btn-outline-danger btn-sm" onclick="deletePersonnelDB()"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-4"><input type="text" id="workRate" class="form-control text-center bg-light fw-bold" placeholder="Ücret"></div>
                            <div class="col-8"><input type="text" id="workIban" class="form-control text-muted small bg-light" placeholder="IBAN Bilgisi" readonly disabled></div>
                        </div>
                        <label class="small fw-bold text-muted mb-1">OTOPARK SEÇ</label>
                        <div class="input-group mb-3">
                            <select id="locationSelect" class="form-select fw-bold"></select>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteLocationDB()"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="bg-light p-2 rounded border mb-3">
                            <input type="date" id="shiftDate" class="form-control fw-bold text-center mb-2">
                            <div class="row g-2">
                                <div class="col-6"><select id="shiftStart" class="form-select text-center fw-bold" onchange="autoCalculateEndTime()"></select></div>
                                <div class="col-6"><select id="shiftEnd" class="form-select text-center fw-bold"></select></div>
                            </div>
                            <button onclick="addShiftToBuffer()" class="btn btn-warning w-100 mt-2 fw-bold btn-sm shadow-sm">Günü Ekle</button>
                        </div>
                        <div class="border rounded bg-white mb-3" style="max-height: 100px; overflow-y: auto;">
                            <table class="table table-sm mb-0"><tbody id="bufferTable"></tbody></table>
                        </div>
                        <button onclick="saveFinalRecord()" class="btn btn-success w-100 fw-bold shadow-sm">LİSTEYE KAYDET</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-xl-9">
                <div class="card h-100 shadow-sm">
                    <div class="card-header justify-content-between"><span>Hazırlanan Liste</span><span class="badge bg-secondary" id="recordCount">0</span></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-custom table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Personel</th>
                                        <th>Otopark</th>
                                        <th>İletişim/IBAN</th>
                                        <th width="35%">Mesai Detayları</th>
                                        <th class="text-center">Saat</th>
                                        <th class="text-end">Tutar</th>
                                        <th class="text-center">S</th>
                                    </tr>
                                </thead>
                                <tbody id="mainTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white py-2">
                        <div class="row align-items-center"><div class="col-md-6"><span id="grandTotal" class="total-display">0,00 ₺</span></div><div class="col-md-6 text-end"><button onclick="generatePDF()" class="btn btn-danger fw-bold btn-sm px-4">PDF RAPORU</button></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow text-center p-4">
            <div class="text-danger mb-2"><i class="fa-solid fa-circle-exclamation fa-3x"></i></div>
            <h5 class="fw-bold">Hata!</h5>
            <p id="alertMsg" class="small text-muted mb-3"></p>
            <button class="btn btn-dark btn-sm w-100" data-bs-dismiss="modal">Tamam</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    const _u = [121, 97, 118, 117, 122], _p = [115, 97, 104, 105, 110];
    function validateLogin() {
        const u = document.getElementById('userInput').value.toLowerCase();
        const p = document.getElementById('passInput').value.toLowerCase();
        if (JSON.stringify(u.split('').map(c=>c.charCodeAt(0))) === JSON.stringify(_u) && JSON.stringify(p.split('').map(c=>c.charCodeAt(0))) === JSON.stringify(_p)) {
            sessionStorage.setItem('isLoggedIn', 'true'); document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainContent').style.display = 'block';
        } else { document.getElementById('loginError').style.display = 'block'; }
    }
    window.onload = function() { if (sessionStorage.getItem('isLoggedIn') === 'true') { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainContent').style.display = 'block'; } }

    let locationDB = [], personnelDB = [], records = [], currentShifts = [];
    let bAlert;

    document.addEventListener("DOMContentLoaded", () => {
        bAlert = new bootstrap.Modal(document.getElementById('alertModal'));
        document.getElementById('shiftDate').valueAsDate = new Date();
        populateTimeSelects(); loadLocal(); fetchServerData();

        document.getElementById('dbPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); 
            if (value.length > 10) value = value.substring(0, 10);
            let formatted = "";
            if (value.length > 0) formatted += "(" + value.substring(0, 3);
            if (value.length >= 3) formatted += ") ";
            if (value.length > 3) formatted += value.substring(3, 6);
            if (value.length >= 6) formatted += " ";
            if (value.length > 6) formatted += value.substring(6, 8);
            if (value.length >= 8) formatted += " ";
            if (value.length > 8) formatted += value.substring(8, 10);
            e.target.value = formatted;
        });
    });

    function showAlert(msg) { document.getElementById('alertMsg').innerText = msg; bAlert.show(); }

    function encryptData(data) { return btoa(unescape(encodeURIComponent(JSON.stringify(data)))).split('').reverse().join('') + "_SECURE"; }
    function decryptData(cipher) { try { return JSON.parse(decodeURIComponent(escape(atob(cipher.replace("_SECURE", "").split('').reverse().join(''))))); } catch (e) { return null; } }
    
    async function fetchServerData() {
        try { const r = await fetch('veriler.txt'); if (r.ok) { const d = decryptData(await r.text()); if (d) { locationDB = d.l || []; personnelDB = d.p || []; saveLocal(); renderLocs(); renderPers(); } } } catch (e) {}
    }

    function loadLocal() {
        const l = localStorage.getItem('v29_l'), p = localStorage.getItem('v29_p'), r = localStorage.getItem('v29_r');
        if(l) locationDB=JSON.parse(l); if(p) personnelDB=JSON.parse(p); if(r) records=JSON.parse(r);
        renderLocs(); renderPers(); renderTable();
    }
    function saveLocal() { localStorage.setItem('v29_l', JSON.stringify(locationDB)); localStorage.setItem('v29_p', JSON.stringify(personnelDB)); localStorage.setItem('v29_r', JSON.stringify(records)); }

    function populateTimeSelects() {
        const s = document.getElementById('shiftStart'), e = document.getElementById('shiftEnd');
        let o = ''; for(let i=0; i<24; i++) { for(let j=0; j<60; j+=30) { let t = `${i<10?'0'+i:i}:${j===0?'00':j}`; o += `<option value="${t}">${t}</option>`; } }
        s.innerHTML = o; e.innerHTML = o; s.value = "09:00"; autoCalculateEndTime();
    }
    function autoCalculateEndTime() {
        const [h, m] = document.getElementById('shiftStart').value.split(':').map(Number);
        let eh = (h + 8) % 24; document.getElementById('shiftEnd').value = `${eh<10?'0'+eh:eh}:${m===0?'00':m}`;
    }

    function addNewLocation() {
        const n = document.getElementById('newLocationName').value.trim().toUpperCase();
        if(!n) return showAlert("Otopark adını giriniz.");
        if(locationDB.includes(n)) return showAlert("Bu otopark zaten kayıtlı.");
        locationDB.push(n); locationDB.sort(); saveLocal(); renderLocs();
        document.getElementById('newLocationName').value = '';
    }

    function addNewPersonnel() {
        const name = document.getElementById('dbName').value.trim().toUpperCase();
        const phoneRaw = document.getElementById('dbPhone').value.replace(/\D/g, ''); 
        const iban = document.getElementById('dbIban').value.trim().toUpperCase();
        const rate = document.getElementById('dbRate').value;
        if(!name) return showAlert("Lütfen isim giriniz.");
        if(phoneRaw.length !== 10) return showAlert("Telefon numarası 10 hane olmalıdır.");
        if(iban.length !== 26) return showAlert("IBAN 26 karakter olmalıdır.");
        personnelDB.push({id:Date.now(), name, phone: document.getElementById('dbPhone').value, iban, rate}); 
        saveLocal(); renderPers();
        document.getElementById('dbName').value=''; document.getElementById('dbPhone').value=''; document.getElementById('dbIban').value='';
    }

    function renderLocs() { const s = document.getElementById('locationSelect'); const val = s.value; s.innerHTML = '<option value="">-- Seçiniz --</option>'; locationDB.forEach(l => s.innerHTML += `<option value="${l}">${l}</option>`); s.value = val; }
    function renderPers() { const s = document.getElementById('personSelect'); const val = s.value; s.innerHTML = '<option value="">-- Seçiniz --</option>'; personnelDB.forEach(p => s.innerHTML += `<option value="${p.id}">${p.name}</option>`); s.value = val; }
    
    function deletePersonnelDB() { const id = document.getElementById('personSelect').value; if(!id) return; if(confirm('Silinsin mi?')) { personnelDB = personnelDB.filter(x=>x.id != id); saveLocal(); renderPers(); resetWorkFields(); } }
    function deleteLocationDB() { const v = document.getElementById('locationSelect').value; if(!v) return; if(confirm('Silinsin mi?')) { locationDB = locationDB.filter(x=>x != v); saveLocal(); renderLocs(); } }
    
    function fillPersonDetails() { 
        const p = personnelDB.find(x=>x.id==document.getElementById('personSelect').value); 
        if(p) { document.getElementById('workRate').value = p.rate; document.getElementById('workIban').value = p.iban; } 
        else { resetWorkFields(); }
    }

    function resetWorkFields() {
        document.getElementById('workRate').value = '';
        document.getElementById('workIban').value = '';
    }

    function addShiftToBuffer() {
        const d = document.getElementById('shiftDate').value, s = document.getElementById('shiftStart').value, e = document.getElementById('shiftEnd').value;
        if(!d) return showAlert("Tarih seçin.");
        let d1 = new Date(`2000-01-01T${s}`), d2 = new Date(`2000-01-01T${e}`), h = (d2 - d1) / 36e5;
        currentShifts.push({date:d, start:s, end:e, hours: (h<0?h+24:h).toFixed(2)});
        currentShifts.sort((a,b)=>new Date(a.date)-new Date(b.date)); renderBuffer();
        document.getElementById('shiftDate').valueAsDate = new Date();
    }
    function renderBuffer() {
        const t = document.getElementById('bufferTable'); t.innerHTML = '';
        currentShifts.forEach((s, i) => t.innerHTML += `<tr><td class="ps-2 fw-bold text-primary">${s.date.split('-').reverse().join('/')} (${s.start}-${s.end})</td><td class="text-end pe-2"><i class="fa-solid fa-xmark text-danger pointer" onclick="currentShifts.splice(${i},1);renderBuffer();"></i></td></tr>`);
    }

    function saveFinalRecord() {
        const pId = document.getElementById('personSelect').value, loc = document.getElementById('locationSelect').value, rate = document.getElementById('workRate').value;
        if(!pId || !loc || currentShifts.length === 0) return showAlert("Bilgiler eksik.");
        const p = personnelDB.find(x=>x.id==pId); let th = 0; currentShifts.forEach(s=>th+=parseFloat(s.hours));
        records.push({id:Date.now(), location:loc, name:p.name, phone:p.phone, iban:p.iban, shifts:[...currentShifts], totalHours:th.toFixed(2), totalCost:(th*parseFloat(rate)).toFixed(2)});
        saveLocal(); renderTable(); 
        
        // --- FORM SIFIRLAMA ---
        currentShifts=[]; 
        renderBuffer();
        document.getElementById('personSelect').value = '';
        document.getElementById('locationSelect').value = '';
        resetWorkFields();
    }

    function renderTable() {
        const tb = document.getElementById('mainTableBody'); tb.innerHTML = ''; let g = 0;
        records.forEach((r, i) => {
            g += parseFloat(r.totalCost);
            let shiftHtml = r.shifts.map(s => `<div class="shift-info-row"><span class="text-primary fw-bold">${s.date.split('-').reverse().join('/')}</span> <span>(${s.start}-${s.end})</span></div>`).join('');
            tb.innerHTML += `<tr><td class="fw-bold">${r.name}</td><td class="text-secondary fw-bold">${r.location}</td><td><div class="small fw-bold">${r.phone}</div><div class="small text-muted font-monospace">${r.iban}</div></td><td>${shiftHtml}</td><td class="text-center fw-bold">${r.totalHours}</td><td class="text-end fw-bold text-success">${parseFloat(r.totalCost).toLocaleString('tr-TR')} ₺</td><td class="text-center"><i class="fa-solid fa-trash text-danger pointer" onclick="records.splice(${i},1);saveLocal();renderTable();"></i></td></tr>`;
        });
        document.getElementById('grandTotal').innerText = g.toLocaleString('tr-TR') + ' ₺';
        document.getElementById('recordCount').innerText = records.length;
    }

    function clearCurrentList() { if(confirm('Liste temizlensin mi?')) { records = []; saveLocal(); renderTable(); } }

    function generatePDF() {
        if(records.length === 0) return;
        const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
        const tr = (str) => { const m={'ğ':'g','Ğ':'G','ş':'s','Ş':'S','ı':'i','İ':'I','ü':'u','Ü':'U','ö':'o','Ö':'O','ç':'c','Ç':'C'}; return str ? str.replace(/[ğĞşŞıİüÜöÖçÇ]/g, k=>m[k]) : ""; };
        doc.autoTable({
            head: [['PERSONEL', 'OTOPARK', 'ILETISIM/IBAN', 'MESAI DETAYLARI', 'SAAT', 'TUTAR']],
            body: records.map(r => [tr(r.name), tr(r.location), `${r.phone}\n${r.iban}`, r.shifts.map(s => `${s.date.split('-').reverse().join('/')} (${s.start}-${s.end})`).join('\n'), r.totalHours + " Saat", parseFloat(r.totalCost).toLocaleString('tr-TR') + " TL"]),
            styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak', valign: 'middle', lineColor: [0, 0, 0], lineWidth: 0.1 },
            headStyles: { fillColor: [44, 62, 80], fontStyle: 'bold' },
            columnStyles: { 3: { cellWidth: 80 }, 5: { halign: 'right', fontStyle: 'bold' } },
            foot: [['', '', '', '', 'TOPLAM:', document.getElementById('grandTotal').innerText.replace('₺','TL')]],
            footStyles: { fillColor: [39, 174, 96], halign: 'right' }
        });
        doc.save("Mesai_Raporu.pdf");
    }

    function downloadBackup() {
        const encrypted = encryptData({l:locationDB, p:personnelDB, r:records});
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([encrypted], {type:"text/plain"})); a.download = "veriler.txt"; a.click();
    }
    function uploadBackup(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => { const d = decryptData(e.target.result); if(d) { locationDB=d.l; personnelDB=d.p; records=d.r; saveLocal(); renderLocs(); renderPers(); renderTable(); } };
        r.readAsText(f);
    }
</script>
</body>
</html>
