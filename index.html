<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO - AKILLI TARAMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.0/dist/tesseract.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; transition: all 0.3s; position: relative; background: white; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.8; }
        .header-banner { background-color: #1a1a1a; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .logo-wrapper { display: flex; align-items: center; gap: 2px; color: white; font-weight: 800; font-size: 20px; }
        .logo-p-badge { background-color: #e11d48; color: white; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin: 0 2px; font-style: italic; }
        
        #cameraModal, #odemeModal { background: rgba(0,0,0,0.95); z-index: 100; }
        .scan-focus-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80px; border: 2px solid #22c55e; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #22c55e; box-shadow: 0 0 15px #22c55e; animation: scanAnim 2s infinite; }
        @keyframes scanAnim { 0% { top: 0; } 100% { top: 100%; } }
        
        #pdfTemplate { width: 100%; background: white; padding: 20px; color: black; display: none; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { background: #1a1a1a; color: white; border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
        .pdf-table td { border: 1px solid #ddd; padding: 8px; font-size: 11px; }
    </style>
</head>
<body class="pb-20">

    <div class="header-banner no-print">
        <div class="logo-wrapper">
            <span class="italic">iSTAY</span>
            <div class="logo-p-badge">P</div>
            <span class="italic">ARK</span>
        </div>
        <div class="flex gap-2">
            <button onclick="kamerayiAc()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg flex items-center gap-2">
                <i class="fas fa-camera"></i> PLAKA TARA
            </button>
            <button onclick="raporuGoster()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg"><i class="fas fa-chart-pie mr-1"></i> RAPORLAR</button>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-6 no-print">
            <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA GİRİN VEYA ARA" class="w-full px-4 py-4 border-2 border-gray-100 rounded-2xl font-black uppercase text-2xl mb-4 text-center focus:border-rose-500 outline-none transition-all">
            <div class="flex gap-3 mb-4">
                <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white">OTOMOBİL</button>
                <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-gray-100 text-gray-500">MİNİBÜS</button>
            </div>
            <button onclick="aracGiris()" class="w-full bg-zinc-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">GİRİŞİ KAYDET</button>
        </div>
        <div id="aracListesi" class="space-y-4"></div>
    </div>

    <div id="cameraModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden relative">
            <div class="p-6">
                <div class="relative rounded-2xl overflow-hidden bg-black aspect-video mb-4">
                    <video id="cameraVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                    <div class="scan-focus-box"><div class="scan-line"></div></div>
                </div>
                <div id="ocrStatus" class="text-center font-bold text-gray-500 mb-4 text-sm uppercase">PLAKAYI HİZALAYIN</div>
                <button onclick="fotografCek()" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black text-lg shadow-xl">TARAYI BAŞLAT</button>
                <button onclick="kamerayiKapat()" class="w-full mt-2 text-gray-400 font-bold py-2">KAPAT</button>
            </div>
        </div>
    </div>

    <div id="odemeModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden">
            <div class="bg-zinc-900 p-6 text-white text-center">
                <h2 id="odemePlaka" class="text-3xl font-black">-</h2>
                <p id="odemeSure" class="text-rose-500 font-bold text-sm italic">Süre Hesaplanıyor...</p>
            </div>
            <div class="p-8">
                <div class="text-center mb-6">
                    <span id="odemeTutar" class="text-6xl font-black text-zinc-900">0.00</span><span class="text-2xl font-black ml-1">TL</span>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="cikisYap('NAKİT')" class="w-full py-4 bg-green-600 text-white rounded-2xl font-bold flex justify-between px-6 items-center">NAKİT <i class="fas fa-money-bill-wave"></i></button>
                    <button onclick="cikisYap('KREDİ KARTI')" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold flex justify-between px-6 items-center">KREDİ KARTI <i class="fas fa-credit-card"></i></button>
                    <button onclick="cikisYap('HGS')" class="w-full py-4 bg-orange-500 text-white rounded-2xl font-bold flex justify-between px-6 items-center">HGS <i class="fas fa-rss"></i></button>
                </div>
                <button onclick="document.getElementById('odemeModal').classList.add('hidden')" class="w-full mt-4 text-gray-400 font-bold">İPTAL</button>
            </div>
        </div>
    </div>

    <div id="raporModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-end sm:items-center justify-center no-print">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-6 bg-zinc-900 text-white flex justify-between items-center">
                <h2 class="text-xl font-black tracking-tight">PARK RAPORU</h2>
                <button onclick="raporuKapat()" class="w-10 h-10 bg-zinc-800 rounded-xl flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" id="raporIcerik">
                </div>
        </div>
    </div>

    <div id="pdfTemplate"></div>

    <script>
        let varsayilanTarife = {
            otomobil: [ { min: 0, max: 1, ucret: 170 }, { min: 1, max: 2, ucret: 210 }, { min: 2, max: 4, ucret: 290 }, { min: 4, max: 6, ucret: 360 }, { min: 6, max: 8, ucret: 420 }, { min: 8, max: 12, ucret: 500 }, { min: 12, max: 24, ucret: 600 } ],
            minibus: [ { min: 0, max: 1, ucret: 250 }, { min: 1, max: 2, ucret: 300 }, { min: 2, max: 4, ucret: 400 }, { min: 4, max: 6, ucret: 500 }, { min: 6, max: 8, ucret: 600 }, { min: 8, max: 12, ucret: 750 }, { min: 12, max: 24, ucret: 900 } ]
        };
        let araclar = JSON.parse(localStorage.getItem('istay_park_data')) || [];
        let seciliAracTipi = 'otomobil';
        let cameraStream = null;
        let aktifOdemeId = null;

        // KAMERA FONKSİYONLARI
        async function kamerayiAc() {
            document.getElementById('cameraModal').classList.remove('hidden');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 } } });
                document.getElementById('cameraVideo').srcObject = cameraStream;
            } catch (err) { alert("Kamera hatası!"); kamerayiKapat(); }
        }

        function kamerayiKapat() {
            if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; }
            document.getElementById('cameraModal').classList.add('hidden');
        }

        async function fotografCek() {
            const video = document.getElementById('cameraVideo');
            const status = document.getElementById('ocrStatus');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const cw = video.videoWidth * 0.7; const ch = 120;
            const sx = (video.videoWidth - cw) / 2; const sy = (video.videoHeight - ch) / 2;
            canvas.width = cw; canvas.height = ch;
            ctx.filter = 'grayscale(1) contrast(2)';
            ctx.drawImage(video, sx, sy, cw, ch, 0, 0, cw, ch);
            status.textContent = "TARANIYOR...";
            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng', { tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' });
                let raw = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
                const match = raw.match(/[0-9]{2}[A-Z]{1,3}[0-9]{2,4}/);
                if (match) {
                    status.textContent = "PLAKA: " + match[0];
                    setTimeout(() => { kamerayiKapat(); plakaIsle(match[0]); }, 500);
                } else { status.textContent = "TEKRAR DENEYİN"; }
            } catch (err) { status.textContent = "HATA!"; }
        }

        function plakaIsle(plaka) {
            const arac = araclar.find(a => a.plaka === plaka && a.durum === 'aktif');
            if (arac) { odemeEkraniAc(arac); } 
            else { document.getElementById('plakaInput').value = plaka; renderList(); }
        }

        // ÜCRET VE ÇIKIŞ
        function ucretHesapla(arac) {
            const giris = new Date(arac.giris);
            const simdi = new Date();
            const farkDk = Math.floor((simdi - giris) / 60000);
            
            // İLK 4 DAKİKA ÜCRETSİZ KURALI
            if (farkDk <= 4) return { ucret: 0, sureMetin: farkDk + " Dakika (Ücretsiz)" };

            const saat = farkDk / 60;
            let ucret = 0;
            const tarife = varsayilanTarife[arac.tip];
            for (let t of tarife) { if (saat >= t.min && saat < t.max) { ucret = t.ucret; break; } }
            if (saat >= 24) ucret = tarife[tarife.length-1].ucret * Math.ceil(saat/24);
            return { ucret: ucret, sureMetin: Math.floor(saat) + " Saat " + (farkDk % 60) + " Dk" };
        }

        function odemeEkraniAc(arac) {
            aktifOdemeId = arac.id;
            const { sureMetin, ucret } = ucretHesapla(arac);
            document.getElementById('odemePlaka').textContent = arac.plaka;
            document.getElementById('odemeSure').textContent = sureMetin;
            document.getElementById('odemeTutar').textContent = ucret;
            document.getElementById('odemeModal').classList.remove('hidden');
        }

        function cikisYap(metod) {
            const index = araclar.findIndex(a => a.id === aktifOdemeId);
            if (index !== -1) {
                araclar[index].durum = 'cikis';
                araclar[index].cikis = new Date().toISOString();
                araclar[index].ucret = document.getElementById('odemeTutar').textContent;
                araclar[index].odemeYontemi = metod;
                localStorage.setItem('istay_park_data', JSON.stringify(araclar));
                document.getElementById('odemeModal').classList.add('hidden');
                renderList();
            }
        }

        // GİRİŞ VE LİSTELEME
        function aracGiris() {
            const plaka = document.getElementById('plakaInput').value.trim().toUpperCase();
            if(!plaka) return;
            araclar.push({ id: Date.now(), plaka, tip: seciliAracTipi, giris: new Date().toISOString(), durum: 'aktif' });
            localStorage.setItem('istay_park_data', JSON.stringify(araclar));
            document.getElementById('plakaInput').value = ""; renderList();
        }

        function saatDuzenle(id) {
            const yeniSaat = prompt("Yeni Giriş Saati (SS:DD):", "12:00");
            if(yeniSaat && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(yeniSaat)) {
                const arac = araclar.find(a => a.id === id);
                const bugun = new Date().toISOString().split('T')[0];
                arac.giris = new Date(bugun + 'T' + yeniSaat).toISOString();
                localStorage.setItem('istay_park_data', JSON.stringify(araclar));
                renderList();
            }
        }

        function setAracTipi(tip) {
            seciliAracTipi = tip;
            document.getElementById('type_oto').className = tip === 'otomobil' ? 'flex-1 py-4 rounded-xl font-bold border-2 border-rose-600 bg-rose-600 text-white' : 'flex-1 py-4 rounded-xl font-bold border-2 border-gray-100 text-gray-500';
            document.getElementById('type_mini').className = tip === 'minibus' ? 'flex-1 py-4 rounded-xl font-bold border-2 border-rose-600 bg-rose-600 text-white' : 'flex-1 py-4 rounded-xl font-bold border-2 border-gray-100 text-gray-500';
        }

        function renderList() {
            const filtre = document.getElementById('plakaInput').value.toUpperCase();
            const liste = document.getElementById('aracListesi');
            liste.innerHTML = '';
            araclar.filter(a => a.durum === 'aktif' && a.plaka.includes(filtre)).reverse().forEach(arac => {
                const { ucret, sureMetin } = ucretHesapla(arac);
                const div = document.createElement('div');
                div.className = 'park-card p-5 shadow-sm flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <div class="font-black text-2xl">${arac.plaka}</div>
                        <div class="text-[10px] font-bold text-gray-400">Giriş: ${new Date(arac.giris).toLocaleTimeString('tr-TR')} | ${sureMetin}</div>
                        <button onclick="saatDuzenle(${arac.id})" class="text-blue-500 text-[10px] font-bold mt-1 uppercase">Saati Düzenle</button>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black text-rose-600">${ucret} TL</div>
                        <button onclick='odemeEkraniAc(${JSON.stringify(arac)})' class="bg-zinc-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold mt-1">ÇIKIŞ</button>
                    </div>
                `;
                liste.appendChild(div);
            });
        }

        // RAPOR FONKSİYONLARI (ORJİNAL YAPI)
        function raporuGoster() {
            const rModal = document.getElementById('raporModal');
            const icerik = document.getElementById('raporIcerik');
            const bugun = new Date().toISOString().split('T')[0];
            const bugunkuAraclar = araclar.filter(a => a.giris.startsWith(bugun));
            const cikanlar = bugunkuAraclar.filter(a => a.durum === 'cikis');
            const toplamGelir = cikanlar.reduce((sum, a) => sum + Number(a.ucret || 0), 0);

            icerik.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-2xl">
                        <span class="text-xs text-gray-400 font-bold block mb-1 uppercase tracking-widest">Bugün Giriş</span>
                        <span class="text-2xl font-black text-zinc-900">${bugunkuAraclar.length}</span>
                    </div>
                    <div class="bg-rose-50 p-4 rounded-2xl">
                        <span class="text-xs text-rose-400 font-bold block mb-1 uppercase tracking-widest">Toplam Hasılat</span>
                        <span class="text-2xl font-black text-rose-600">${toplamGelir} TL</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <button onclick="pdfKaydet()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3"><i class="fas fa-file-pdf"></i> PDF GÜNLÜK RAPOR</button>
                    <button onclick="verileriSifirla()" class="w-full bg-red-100 text-red-600 py-4 rounded-2xl font-bold">TÜM VERİLERİ SIFIRLA</button>
                </div>
            `;
            rModal.classList.remove('hidden');
        }

        function raporuKapat() { document.getElementById('raporModal').classList.add('hidden'); }
        
        function verileriSifirla() {
            if(confirm("Tüm park verileri silinecek. Emin misiniz?")) {
                localStorage.removeItem('istay_park_data');
                araclar = [];
                renderList();
                raporuKapat();
            }
        }

        function pdfKaydet() {
            const bugun = new Date().toLocaleDateString('tr-TR');
            let rows = araclar.filter(a => a.durum === 'cikis').map(a => `
                <tr>
                    <td>${a.plaka}</td>
                    <td>${new Date(a.giris).toLocaleTimeString()}</td>
                    <td>${new Date(a.cikis).toLocaleTimeString()}</td>
                    <td>${a.ucret} TL</td>
                    <td>${a.odemeYontemi || 'Nakit'}</td>
                </tr>
            `).join('');

            const template = `
                <div style="padding:20px; font-family:Arial">
                    <h2>iSTAY PARK - GÜNLÜK RAPOR (${bugun})</h2>
                    <table class="pdf-table" border="1" style="width:100%; border-collapse:collapse">
                        <thead><tr><th>PLAKA</th><th>GİRİŞ</th><th>ÇIKIŞ</th><th>TUTAR</th><th>ÖDEME</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
            const opt = { margin: 1, filename: 'istay-rapor.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(template).save();
        }

        renderList();
    </script>
</body>
</html>
