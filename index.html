<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK - SADECE PLAKA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { background: #121212; font-family: sans-serif; }
        /* Kamera Tarama Alanı Tasarımı */
        #cameraOverlay { display: none; position: fixed; inset: 0; background: black; z-index: 100; }
        #v { width: 100%; height: 100%; object-fit: cover; }
        .focus-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 100px; border: 4px solid #e11d48; border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); z-index: 110;
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #e11d48;
            top: 0; left: 0; box-shadow: 0 0 15px #e11d48;
            animation: moveScan 2s linear infinite;
        }
        @keyframes moveScan { from { top: 0; } to { top: 100%; } }
        .park-card { border-left: 6px solid #e11d48; background: white; border-radius: 12px; }
    </style>
</head>
<body class="pb-20">

    <div class="p-4 flex justify-between items-center bg-zinc-900 border-b border-zinc-800">
        <div class="text-white font-black italic text-xl">iSTAY <span class="bg-rose-600 px-2 rounded">P</span> ARK</div>
        <div id="loader" class="hidden text-rose-500 text-xs font-bold uppercase">Taranıyor...</div>
    </div>

    <div id="cameraOverlay">
        <video id="v" autoplay playsinline></video>
        <div class="focus-box">
            <div class="scan-line"></div>
            <p class="absolute -top-8 left-0 text-white text-[10px] font-bold">PLAKAYI BU ALANA GETİRİN</p>
        </div>
        <div class="absolute bottom-10 left-0 right-0 flex justify-around items-center z-[120]">
            <button onclick="stopC()" class="text-white opacity-60 font-bold">VAZGEÇ</button>
            <button onclick="snap()" class="w-20 h-20 bg-rose-600 rounded-full border-4 border-white flex items-center justify-center">
                <i class="fas fa-camera text-3xl text-white"></i>
            </button>
            <div class="w-10"></div>
        </div>
        <canvas id="c" style="display:none;"></canvas>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-zinc-800 rounded-3xl p-6 shadow-2xl mb-6">
            <div class="relative flex items-center mb-6">
                <input type="text" id="pInp" oninput="draw()" placeholder="PLAKA BEKLENİYOR" class="w-full py-5 bg-zinc-900 border-2 border-zinc-700 rounded-2xl font-black text-3xl text-center uppercase text-white outline-none focus:border-rose-600 transition-all">
                <button onclick="startC()" class="absolute right-3 w-14 h-14 bg-rose-600 rounded-xl flex items-center justify-center text-white shadow-lg active:scale-90 transition">
                    <i class="fas fa-expand text-xl"></i>
                </button>
            </div>
            
            <div id="actionArea" class="space-y-4">
                <div class="flex gap-2">
                    <button id="tO" onclick="setT('otomobil')" class="flex-1 py-3 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white">OTOMOBİL</button>
                    <button id="tM" onclick="setT('minibus')" class="flex-1 py-3 rounded-xl font-bold text-xs border-2 border-zinc-700 text-zinc-400">MİNİBÜS</button>
                </div>
                <button onclick="save()" class="w-full bg-white text-zinc-900 py-4 rounded-2xl font-black text-lg active:scale-95 transition">GİRİŞİ KAYDET</button>
            </div>
        </div>

        <div id="list" class="space-y-4"></div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('istay_v7')) || [];
        let type = 'otomobil';
        let stream = null;

        async function startC() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280, height: 720 } });
                document.getElementById('v').srcObject = stream;
                document.getElementById('cameraOverlay').style.display = 'block';
            } catch (e) { alert("Kamera açılamadı. Lütfen izin verin."); }
        }

        function stopC() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraOverlay').style.display = 'none';
        }

        async function snap() {
            const video = document.getElementById('v');
            const canvas = document.getElementById('c');
            const ctx = canvas.getContext('2d');
            
            // SADECE KIRMIZI ALANI KES (CROP)
            // Video boyutlarına göre oranlama yapıyoruz
            const scale = video.videoWidth / video.clientWidth;
            const w = 80 * (video.clientWidth / 100) * scale;
            const h = 100 * scale;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(video, x, y, w, h, 0, 0, w, h);
            
            document.getElementById('loader').classList.remove('hidden');
            runOCR(canvas.toDataURL('image/jpeg', 0.9));
        }

        async function runOCR(src) {
            try {
                const worker = await Tesseract.createWorker('eng');
                const { data: { text } } = await worker.recognize(src);
                await worker.terminate();

                // PLAKA AYIKLAMA (Regex): Sadece harf ve rakamları al
                let raw = text.replace(/[^A-Z0-9]/gi, "").toUpperCase();
                
                // Türkiye Plaka Mantığı: 2 rakamla başlar (Genellikle)
                // Basitçe: 5 ile 9 karakter arası her şeyi plaka kabul et
                if(raw.length >= 5 && raw.length <= 9) {
                    document.getElementById('pInp').value = raw;
                    stopC();
                    draw();
                } else {
                    alert("Plaka bulunamadı. Lütfen çerçeveye tam hizalayın.");
                }
            } catch (e) { alert("Sistem hatası. Tekrar deneyin."); }
            document.getElementById('loader').classList.add('hidden');
        }

        function draw() {
            const val = document.getElementById('pInp').value.toUpperCase();
            const listCont = document.getElementById('list');
            const actionArea = document.getElementById('actionArea');
            listCont.innerHTML = '';

            const isInside = db.find(a => a.p === val && a.d === 'aktif');
            actionArea.style.display = isInside ? 'none' : 'block';

            db.filter(a => a.p.includes(val))
              .sort((a,b) => (a.d === 'aktif' ? -1 : 1))
              .forEach(a => {
                const isA = a.d === 'aktif';
                const div = document.createElement('div');
                div.className = `p-5 shadow-xl ${isA ? 'park-card' : 'bg-zinc-800 opacity-60 border-l-4 border-zinc-600 text-zinc-400'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-[9px] font-bold uppercase">${a.t}</span>
                            <h2 class="text-2xl font-black ${isA?'text-zinc-900':'text-zinc-300'}">${a.p}</h2>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-black ${isA?'text-rose-600':'text-zinc-400'}">${isA ? calc(a.g) : a.price} TL</span>
                        </div>
                    </div>
                    ${isA ? `
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="out(${a.id},'HGS')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[10px]">HGS</button>
                        <button onclick="out(${a.id},'KART')" class="bg-emerald-600 text-white py-3 rounded-xl font-bold text-[10px]">KART</button>
                        <button onclick="out(${a.id},'NAKİT')" class="bg-amber-500 text-white py-3 rounded-xl font-bold text-[10px]">NAKİT</button>
                    </div>` : ''}
                `;
                listCont.appendChild(div);
            });
        }

        function save() {
            const p = document.getElementById('pInp').value.trim().toUpperCase();
            if(!p) return;
            db.push({ id: Date.now(), p, t: type, g: new Date().toISOString(), d: 'aktif' });
            localStorage.setItem('istay_v7', JSON.stringify(db));
            document.getElementById('pInp').value = "";
            draw();
        }

        function out(id, pay) {
            const a = db.find(x => x.id === id);
            a.price = calc(a.g);
            a.pay = pay;
            a.d = 'done';
            localStorage.setItem('istay_v7', JSON.stringify(db));
            document.getElementById('pInp').value = "";
            draw();
        }

        function calc(g) { return 170; } // Örnek sabit ucret
        function setT(v) { 
            type = v; 
            document.getElementById('tO').className = v === 'otomobil' ? 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white' : 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-zinc-700 text-zinc-400';
            document.getElementById('tM').className = v === 'minibus' ? 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-blue-600 bg-blue-600 text-white' : 'flex-1 py-3 rounded-xl font-bold text-xs border-2 border-zinc-700 text-zinc-400';
        }

        draw();
    </script>
</body>
</html>
