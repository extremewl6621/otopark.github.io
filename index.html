<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK AI PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
    <style>
        body { background: #0f172a; font-family: sans-serif; color: white; }
        #cameraOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #videoStream { width: 100%; height: 100%; object-fit: cover; }
        .focus-frame { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 80px; border: 4px solid #34d399; border-radius: 12px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.85); z-index: 1010;
        }
        .laser-scan { position: absolute; inset: 0; background: rgba(52, 211, 153, 0.2); height: 2px; border-bottom: 2px solid #34d399; animation: scan 2s infinite; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
    </style>
</head>
<body class="p-4">

    <div id="cameraOverlay">
        <video id="videoStream" autoplay playsinline></video>
        <div class="focus-frame"><div class="laser-scan"></div></div>
        <div class="absolute bottom-10 inset-x-0 flex flex-col items-center gap-6 z-[1100]">
            <div id="status" class="bg-emerald-600 text-[11px] px-6 py-2 rounded-full font-bold">PLAKAYI ÇERÇEVEYE SIĞDIRIN</div>
            <div class="flex items-center gap-10">
                <button onclick="closeCam()" class="opacity-50 font-bold uppercase text-xs">Kapat</button>
                <button onclick="processPlate()" class="w-20 h-20 bg-white rounded-full border-8 border-emerald-500 shadow-2xl flex items-center justify-center active:scale-90">
                    <i class="fas fa-camera text-2xl text-emerald-600"></i>
                </button>
                <div class="w-10"></div>
            </div>
        </div>
        <canvas id="cropCanvas" style="display:none;"></canvas>
    </div>

    <div class="max-w-md mx-auto space-y-6 pt-10">
        <div class="bg-slate-800 p-6 rounded-[2.5rem] shadow-2xl border border-slate-700">
            <div class="relative mb-6">
                <input type="text" id="plateInput" placeholder="00 AAA 000" class="w-full py-6 text-4xl font-black text-center bg-slate-900 border-2 border-slate-700 rounded-2xl focus:border-emerald-500 outline-none uppercase text-white tracking-tighter">
                <button onclick="openCam()" class="absolute right-3 top-3 bottom-3 w-14 bg-emerald-600 rounded-xl shadow-lg active:scale-95 flex items-center justify-center text-white">
                    <i class="fas fa-camera text-xl"></i>
                </button>
            </div>
            <button onclick="addCar()" class="w-full bg-white text-slate-900 py-5 rounded-2xl font-black text-xl hover:bg-emerald-500 transition-all">GİRİŞİ KAYDET</button>
        </div>

        <div id="carList" class="space-y-3"></div>
    </div>

    <script>
        let cars = JSON.parse(localStorage.getItem('istay_park_ai')) || [];
        let stream = null;

        // KARAKTER DÜZELTME TABLOSU (OCR Hataları için)
        const corrections = { 'M': '3', 'S': '5', 'G': '6', 'B': '8', 'O': '0', 'I': '1', 'Z': '2', 'Q': '0' };

        async function openCam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280 } });
                document.getElementById('videoStream').srcObject = stream;
                document.getElementById('cameraOverlay').style.display = 'block';
            } catch(e) { alert("Kamera izni gerekiyor."); }
        }

        function closeCam() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraOverlay').style.display = 'none';
        }

        async function processPlate() {
            const video = document.getElementById('videoStream');
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');

            const scale = video.videoWidth / video.clientWidth;
            const w = 85 * (video.clientWidth / 100) * scale;
            const h = 80 * scale;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight * 0.4) - (h / 2);

            canvas.width = w; canvas.height = h;
            // Keskinleştirme ve kontrast
            ctx.filter = 'grayscale(1) contrast(3.5) brightness(1.1)';
            ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

            status.innerHTML = '<i class="fas fa-sync fa-spin"></i> OKUNUYOR...';

            try {
                const worker = await Tesseract.createWorker('eng');
                await worker.setParameters({ 
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE
                });
                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                let raw = text.replace(/[^A-Z0-9]/g, "").trim();
                
                // --- AKILLI DÜZELTME MANTİĞI ---
                // Eğer plaka bir harfle başlıyorsa (Örn: M3L yerine 38L) ilk karakteri düzelt
                if (raw.length > 2 && isNaN(raw[0])) {
                    let firstChar = raw[0];
                    if (corrections[firstChar]) {
                        raw = corrections[firstChar] + raw.substring(1);
                    }
                }

                // Türkiye formatına uygun kısmını kes (Max 9 karakter)
                let final = raw.length > 9 ? raw.substring(0, 9) : raw;

                if(final.length >= 5) {
                    document.getElementById('plateInput').value = final;
                    closeCam();
                    render();
                } else {
                    status.innerText = "TEKRAR DENEYİN (NET DEĞİL)";
                }
            } catch(e) { status.innerText = "HATA!"; }
        }

        function addCar() {
            let p = document.getElementById('plateInput').value.trim().toUpperCase();
            if(!p) return;
            // Mükerrer Kayıt Engeli
            if(cars.some(c => c.p === p && c.s === 'aktif')) return alert("ARAÇ İÇERİDE!");

            cars.unshift({ id: Date.now(), p: p, t: new Date().toISOString(), s: 'aktif' });
            saveData();
            document.getElementById('plateInput').value = '';
            render();
        }

        function exitCar(id) {
            let c = cars.find(x => x.id === id);
            c.s = 'bitti';
            c.ct = new Date().toISOString();
            saveData();
            render();
        }

        function render() {
            const list = document.getElementById('carList');
            list.innerHTML = '';
            
            // Aktifler üstte, bitenler altta
            let sorted = [...cars.filter(x => x.s === 'aktif'), ...cars.filter(x => x.s === 'bitti')];

            sorted.forEach(c => {
                const isAktif = c.s === 'aktif';
                list.innerHTML += `
                    <div class="p-5 rounded-2xl border ${isAktif ? 'bg-slate-800 border-slate-700' : 'bg-slate-900 border-slate-800 opacity-60'} flex justify-between items-center shadow-lg">
                        <div>
                            <div class="text-2xl font-black ${isAktif ? 'text-white' : 'text-slate-500'}">${c.p}</div>
                            <div class="text-[10px] font-bold text-slate-500 mt-1 uppercase">${new Date(c.t).toLocaleString()}</div>
                        </div>
                        ${isAktif ? 
                            `<button onclick="exitCar(${c.id})" class="bg-emerald-600/20 text-emerald-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase">ÇIKIŞ YAP</button>` : 
                            `<span class="text-slate-600 text-[10px] font-black uppercase">ÇIKTI</span>`
                        }
                    </div>
                `;
            });
        }

        function saveData() { localStorage.setItem('istay_park_ai', JSON.stringify(cars)); }
        render();
    </script>
</body>
</html>
