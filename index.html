<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO - Kesin Çözüm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { background-color: #f4f4f4; font-family: sans-serif; overflow-x: hidden; }
        .park-card { border-left: 6px solid #e11d48; border-radius: 12px; background: white; margin-bottom: 10px; }
        .completed-card { border-left: 6px solid #9ca3af; opacity: 0.8; background: #fdfdfd; }
        
        /* Kamera Gelişmiş Tasarım */
        #cameraOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 100; }
        #videoStream { width: 100%; height: 100%; object-fit: cover; }
        .cam-frame { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 120px; border: 4px solid #3b82f6; border-radius: 15px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); z-index: 110;
        }
        .scan-line { position: absolute; width: 100%; height: 3px; background: #3b82f6; top: 0; animation: scan 2s infinite linear; box-shadow: 0 0 15px #3b82f6; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        #paymentPopup { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div class="bg-zinc-900 p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="text-white font-black italic text-xl">iSTAY <span class="bg-rose-600 px-2 rounded italic">P</span> ARK</div>
        <button onclick="location.reload()" class="text-white/50 text-xs font-bold uppercase">Yenile</button>
    </div>

    <div id="cameraOverlay">
        <video id="videoStream" autoplay playsinline></video>
        <div class="cam-frame">
            <div class="scan-line"></div>
            <div class="absolute -top-8 left-0 text-blue-400 font-bold text-[10px] uppercase tracking-widest">TR Plaka Odaklama</div>
        </div>
        <div class="absolute bottom-12 inset-x-0 flex flex-col items-center gap-6 z-[120]">
            <div id="camStatus" class="text-white text-xs font-bold bg-blue-600/80 backdrop-blur px-6 py-2 rounded-full">PLAKAYI KUTUYA ORTALAYIN</div>
            <div class="flex gap-12 items-center">
                <button onclick="kapatKamera()" class="text-white/60 font-black uppercase text-xs">İPTAL</button>
                <button onclick="yakalaVeOku()" class="w-20 h-20 bg-white rounded-full border-[6px] border-blue-500 flex items-center justify-center active:scale-90 shadow-[0_0_30px_rgba(59,130,246,0.5)]">
                    <i class="fas fa-camera text-3xl text-blue-600"></i>
                </button>
                <div class="w-10"></div>
            </div>
        </div>
        <canvas id="procCanvas" style="display:none;"></canvas>
    </div>

    <div id="paymentPopup">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <div class="text-center mb-8">
                <h2 id="popPlaka" class="text-4xl font-black text-zinc-800 tracking-tighter">---</h2>
                <div id="popTutar" class="text-6xl font-black text-rose-600 mt-4">0<small class="text-xl">TL</small></div>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="sonucCikis('HGS')" class="bg-blue-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg">HGS ÇIKIŞ</button>
                <button onclick="sonucCikis('KART')" class="bg-zinc-900 text-white py-5 rounded-2xl font-black uppercase shadow-lg">KART ÖDEME</button>
                <button onclick="sonucCikis('NAKİT')" class="bg-emerald-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg">NAKİT ÖDEME</button>
                <button onclick="document.getElementById('paymentPopup').style.display='none'" class="text-zinc-400 font-bold mt-2">KAPAT</button>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl p-6 shadow-sm mb-6">
            <div class="relative mb-4">
                <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA GİRİN" class="w-full px-4 py-5 border-2 border-zinc-100 bg-zinc-50 rounded-2xl font-black uppercase text-3xl text-center focus:border-rose-500 outline-none transition-all">
                <button onclick="kameraAc()" class="absolute right-2 top-2 bottom-2 w-14 bg-rose-600 text-white rounded-xl shadow-lg active:scale-95"><i class="fas fa-camera text-xl"></i></button>
            </div>
            <div class="flex gap-3 mb-4">
                <button id="t_oto" onclick="secTip('otomobil')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white">OTOMOBİL</button>
                <button id="t_mini" onclick="secTip('minibus')" class="flex-1 py-4 rounded-xl font-bold text-xs border-2 border-zinc-100 text-zinc-500">MİNİBÜS</button>
            </div>
            <button onclick="kaydet()" class="w-full bg-zinc-900 text-white py-5 rounded-2xl font-black text-xl shadow-xl">GİRİŞİ KAYDET</button>
        </div>

        <div id="liste" class="space-y-3"></div>
    </div>

    <script>
        let araclar = JSON.parse(localStorage.getItem('istay_data')) || [];
        let tip = 'otomobil';
        let stream = null;
        let aktifId = null;

        // --- KAMERA SİSTEMİ (GELİŞTİRİLMİŞ) ---
        async function kameraAc() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', focusMode: 'continuous', width: { ideal: 1280 } } 
                });
                document.getElementById('videoStream').srcObject = stream;
                document.getElementById('cameraOverlay').style.display = 'block';
            } catch (err) {
                if(err.name === 'NotAllowedError') {
                    alert("HATA: Kamera izni reddedildi. Lütfen tarayıcı ayarlarından kamera iznini açın.");
                } else {
                    alert("Kamera başlatılamadı: " + err.message);
                }
            }
        }

        function kapatKamera() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraOverlay').style.display = 'none';
        }

        async function yakalaVeOku() {
            const video = document.getElementById('videoStream');
            const canvas = document.getElementById('procCanvas');
            const ctx = canvas.getContext('2d');
            
            // Plaka alanını kes (Crop)
            const scale = video.videoWidth / video.clientWidth;
            const w = 85 * (video.clientWidth / 100) * scale;
            const h = 120 * scale;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = w; canvas.height = h;

            // GÖRÜNTÜ İŞLEME: Kontrast ve Eşikleme (Saçma karakterleri engeller)
            ctx.filter = 'contrast(200%) brightness(120%) grayscale(100%)';
            ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

            document.getElementById('camStatus').innerText = "AI ANALİZ EDİYOR...";

            try {
                const worker = await Tesseract.createWorker('eng');
                // Sadece büyük harf ve rakamları tanıması için kısıtla
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                });
                
                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                // Temizlik: Gereksiz boşlukları sil ve TR plaka formatına yaklaştır
                let plaka = text.toUpperCase().replace(/[^A-Z0-9]/g, "").trim();
                
                if(plaka.length >= 5) {
                    kapatKamera();
                    islemYap(plaka);
                } else {
                    document.getElementById('camStatus').innerText = "OKUNAMADI! DAHA YAKINDAN DENEYİN";
                }
            } catch (e) {
                alert("Okuma hatası: " + e.message);
            }
        }

        function islemYap(plaka) {
            const icerideki = araclar.find(a => a.plaka === plaka && a.durum === 'aktif');
            if(icerideki) {
                aktifId = icerideki.id;
                document.getElementById('popPlaka').innerText = plaka;
                document.getElementById('popTutar').innerHTML = hesapla(icerideki.giris, icerideki.tip) + '<small class="text-xl">TL</small>';
                document.getElementById('paymentPopup').style.display = 'flex';
            } else {
                document.getElementById('plakaInput').value = plaka;
                renderList();
            }
        }

        // --- MANTIK SİSTEMİ ---
        function kaydet() {
            const p = document.getElementById('plakaInput').value.trim().toUpperCase();
            if(!p) return;
            if(araclar.some(a => a.plaka === p && a.durum === 'aktif')) return alert("ARAÇ ZATEN İÇERİDE!");

            araclar.push({ id: Date.now(), plaka: p, tip: tip, giris: new Date().toISOString(), durum: 'aktif', tutar: 0, odeme: '' });
            veriyiKaydet();
            document.getElementById('plakaInput').value = '';
            renderList();
        }

        function sonucCikis(yontem) {
            const a = araclar.find(x => x.id === aktifId);
            a.durum = 'tamamlandi';
            a.odeme = yontem;
            a.tutar = hesapla(a.giris, a.tip);
            a.cikis = new Date().toISOString();
            veriyiKaydet();
            document.getElementById('paymentPopup').style.display = 'none';
            renderList();
        }

        function renderList() {
            const ara = document.getElementById('plakaInput').value.toUpperCase();
            const div = document.getElementById('liste');
            div.innerHTML = '';

            // SIRALAMA: Aktifler A-Z (Üstte), Tamamlananlar (En altta)
            let aktifler = araclar.filter(a => a.durum === 'aktif' && a.plaka.includes(ara))
                                 .sort((a,b) => a.plaka.localeCompare(b.plaka));
            
            let bitenler = araclar.filter(a => a.durum === 'tamamlandi' && a.plaka.includes(ara))
                                 .sort((a,b) => new Date(b.cikis) - new Date(a.cikis));

            [...aktifler, ...bitenler].forEach(a => {
                const isBitti = a.durum === 'tamamlandi';
                const tl = isBitti ? a.tutar : hesapla(a.giris, a.tip);
                
                div.innerHTML += `
                    <div class="p-4 ${isBitti ? 'completed-card' : 'park-card shadow-sm'} relative">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[9px] font-bold text-gray-400 uppercase">${a.tip}</span>
                                <h3 class="text-2xl font-black text-zinc-800">${a.plaka}</h3>
                                <p class="text-[10px] text-gray-400 font-bold">${new Date(a.giris).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} Giriş</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black ${isBitti ? 'text-zinc-400' : 'text-rose-600'}">${tl} TL</div>
                                <div class="text-[9px] font-bold uppercase">${isBitti ? 'ÖDENDİ ('+a.odeme+')' : 'İÇERİDE'}</div>
                            </div>
                        </div>
                        ${!isBitti ? `
                        <div class="flex gap-2 mt-3">
                            <button onclick="hizliOdemeAc(${a.id})" class="flex-1 bg-zinc-900 text-white text-[10px] py-2 rounded-lg font-bold">ÖDEME AL</button>
                            <button onclick="sil(${a.id})" class="w-10 bg-gray-100 text-gray-400 py-2 rounded-lg"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>
                `;
            });
        }

        function hizliOdemeAc(id) {
            const a = araclar.find(x => x.id === id);
            aktifId = id;
            islemYap(a.plaka);
        }

        function hesapla(giris, t) {
            const fark = (new Date() - new Date(giris)) / 3600000;
            // Basit Tarife Örneği (Kendi tarifene göre güncelle)
            if(t === 'otomobil') return fark <= 1 ? 170 : 250;
            return fark <= 1 ? 250 : 350;
        }

        function secTip(s) {
            tip = s;
            document.getElementById('t_oto').className = s === 'otomobil' ? 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white' : 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-zinc-100 text-zinc-500';
            document.getElementById('t_mini').className = s === 'minibus' ? 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-rose-600 bg-rose-600 text-white' : 'flex-1 py-4 rounded-xl font-bold text-xs border-2 border-zinc-100 text-zinc-500';
        }

        function sil(id) { if(confirm('Silinsin mi?')) { araclar = araclar.filter(a => a.id !== id); veriyiKaydet(); renderList(); } }
        function veriyiKaydet() { localStorage.setItem('istay_data', JSON.stringify(araclar)); }

        renderList();
    </script>
</body>
</html>
