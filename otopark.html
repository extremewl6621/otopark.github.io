<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSTAY PARK PRO - TERMİNAL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { 500: '#e11d48' }, darkbg: '#0f172a', darkcard: '#1e293b' }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; transition: all 0.3s; }
        ::-webkit-scrollbar { width: 0px; }
        .park-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .done-card { opacity: 0.7; filter: grayscale(0.2); border-left: 4px solid #94a3b8 !important; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-darkbg dark:text-white pb-24">

    <div id="mainInterface" class="hidden">
        <header class="fixed top-0 w-full z-40 px-4 h-16 bg-white/90 dark:bg-darkbg/90 backdrop-blur-md flex items-center justify-between border-b dark:border-slate-800">
            <div class="flex flex-col">
                <span id="subeAdiLabel" class="font-black italic text-brand-500 text-lg uppercase tracking-tighter">İSTAY PARK</span>
                <span id="aktifUserLabel" class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">--</span>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center transition">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
                <button onclick="logOut()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-rose-500">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>

        <main class="max-w-lg mx-auto pt-20 px-4">
            <div id="islemPaneli" class="bg-white dark:bg-darkcard rounded-[2rem] p-5 shadow-xl mb-4 border dark:border-slate-800">
                <input type="text" id="plakaInput" oninput="renderList()" placeholder="PLAKA" 
                    class="w-full h-16 bg-slate-50 dark:bg-slate-900 border-none rounded-2xl text-center text-3xl font-black uppercase outline-none dark:text-white focus:ring-2 ring-brand-500/30 transition-all">
                <div class="flex gap-2 my-4">
                    <button id="type_oto" onclick="setAracTipi('otomobil')" class="flex-1 py-3 rounded-xl font-black text-[10px] bg-brand-500 text-white shadow-lg transition-all">OTO</button>
                    <button id="type_mini" onclick="setAracTipi('minibus')" class="flex-1 py-3 rounded-xl font-black text-[10px] bg-slate-100 dark:bg-slate-800 text-slate-500 transition-all">MİNİ</button>
                    <button id="type_abone" onclick="setAracTipi('abone')" class="flex-1 py-3 rounded-xl font-black text-[10px] border-2 border-purple-500 text-purple-500 bg-transparent transition-all">ABONE</button>
                </div>
                <button onclick="aracGiris()" class="w-full bg-slate-900 dark:bg-white dark:text-black text-white py-4 rounded-xl font-black uppercase shadow-lg active:scale-95 transition-all text-xs tracking-widest">KAYDI OLUŞTUR</button>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-white dark:bg-darkcard p-3 rounded-2xl shadow-md border dark:border-slate-800 text-center">
                    <p class="text-[8px] font-bold text-slate-400 uppercase">Giriş</p>
                    <h2 id="toplamGirisSayisi" class="text-xl font-black text-blue-500 italic">0</h2>
                </div>
                <div class="bg-white dark:bg-darkcard p-3 rounded-2xl shadow-md border dark:border-slate-800 text-center">
                    <p class="text-[8px] font-bold text-slate-400 uppercase">Çıkış</p>
                    <h2 id="toplamCikisSayisi" class="text-xl font-black text-rose-500 italic">0</h2>
                </div>
                <div class="bg-white dark:bg-darkcard p-3 rounded-2xl shadow-md border dark:border-slate-800 text-center ring-2 ring-emerald-500/20">
                    <p class="text-[8px] font-bold text-slate-400 uppercase">İçeride</p>
                    <h2 id="iceridekiAracSayisi" class="text-xl font-black text-emerald-500 italic">0</h2>
                </div>
            </div>

            <div id="aracListesi" class="space-y-4 pb-10"></div>
        </main>
    </div>

    <script>
        // [Temel fonksiyonlar: syncCloud, uploadCloud, b64 vb. aynı]
        
        function renderList() {
            const list = document.getElementById('aracListesi');
            const filter = document.getElementById('plakaInput').value.toUpperCase();
            list.innerHTML = "";
            if(!currentPark) return;

            const today = new Date().toDateString();
            const todayLogs = db.kayitlar.filter(a => {
                const isMyPark = a.parkId == currentPark.id;
                const matchesFilter = a.plaka.includes(filter);
                const isToday = new Date(a.giris).toDateString() === today || (a.cikis && new Date(a.cikis).toDateString() === today);
                return isMyPark && matchesFilter && isToday;
            });

            // İstatistik güncelle
            document.getElementById('toplamGirisSayisi').innerText = todayLogs.length;
            document.getElementById('toplamCikisSayisi').innerText = todayLogs.filter(a => a.durum === 'tamamlandi').length;
            document.getElementById('iceridekiAracSayisi').innerText = todayLogs.filter(a => a.durum === 'aktif').length;

            // Sıralama
            todayLogs.sort((a, b) => (a.durum === 'aktif' ? -1 : 1));

            todayLogs.forEach(a => {
                const isAktif = a.durum === 'aktif';
                const fee = isAktif ? calculateFee(a.giris, a.tip) : a.tutar;
                
                // TARİH VE SAAT FORMATLAMA
                const girisTarihi = new Date(a.giris).toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit'});
                const girisSaati = new Date(a.giris).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                const cikisSaati = a.cikis ? new Date(a.cikis).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '';

                list.innerHTML += `
                <div class="bg-white dark:bg-darkcard p-4 rounded-[1.5rem] shadow-lg border dark:border-slate-800 park-card ${!isAktif ? 'done-card' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-slate-900 flex items-center justify-center text-slate-400">
                                <i class="fas ${a.tip === 'minibus' ? 'fa-bus' : 'fa-car'}"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-black text-slate-900 dark:text-white uppercase tracking-tighter">${a.plaka}</h3>
                                <div class="space-y-0.5">
                                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                                        <i class="far fa-clock mr-1"></i>Giriş: ${girisTarihi} - ${girisSaati}
                                    </p>
                                    ${!isAktif ? `
                                    <p class="text-[9px] font-bold text-rose-500 uppercase tracking-widest">
                                        <i class="fas fa-sign-out-alt mr-1"></i>Çıkış: ${cikisSaati}
                                    </p>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xl font-black ${isAktif ? 'text-emerald-500' : 'text-slate-400'} tracking-tighter">${fee}₺</span>
                            ${isAktif ? `<button onclick="openEditModal(${a.id})" class="text-slate-300 mt-1"><i class="fas fa-pen text-[10px]"></i></button>` : ''}
                        </div>
                    </div>

                    <div class="flex gap-2">
                        ${isAktif ? `
                            <button onclick="cikis(${a.id},${fee},'NAKİT')" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-black text-[10px] uppercase shadow-lg">NAKİT</button>
                            <button onclick="cikis(${a.id},${fee},'KART')" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase">KART</button>
                            <button onclick="cikis(${a.id},${fee},'HGS')" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-black text-[10px] uppercase">HGS</button>
                        ` : `
                            <div class="flex-1 flex justify-between items-center px-4 py-2.5 bg-slate-50 dark:bg-slate-900/50 rounded-xl">
                                <span class="text-[9px] font-black text-slate-500 uppercase italic">Ödeme: ${a.odeme}</span>
                                <i class="fas fa-check-circle text-emerald-500"></i>
                            </div>
                        `}
                        <button onclick="sil(${a.id})" class="w-12 py-3 bg-slate-100 dark:bg-slate-800 text-rose-500 rounded-xl transition flex items-center justify-center">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
        }

        // [Diğer fonksiyonlar: sil, aracGiris, cikis, toggleTheme, initTheme vb. aynı]
        // Tema fonksiyonlarını sayfa yenilendiğinde çalışacak şekilde initTheme() ile bağlamayı unutmayın.
    </script>
</body>
</html>
